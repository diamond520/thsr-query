# Milestone v2.0: UX Enhancement

**Status:** ✅ SHIPPED 2026-02-19
**Phases:** 1–7
**Total Plans:** 18

## Overview

Full Next.js 16 rewrite of the THSR Query tool — from Vue 2 + PTX API to Next.js App Router + TDX API — with a secure server-side credential boundary, four query modes (by-time, by-train, by-station, round-trip), visual station picker, shareable URLs, and saved favorite routes.

Phases 1–4 formed the initial v1 foundation. Phases 5–7 delivered the v2.0 UX Enhancement features.

## Phases

### Phase 1: Foundation

**Goal**: 安全的 Next.js 16 專案架構已就位，TDX credentials 永遠不會暴露至前端，所有後續 phase 依賴的 API proxy 層已可用
**Depends on**: Nothing (first phase)
**Plans**: 3 plans

Plans:
- [x] 01-01-PLAN.md — Next.js 16 scaffold: archive Vue 2, create-next-app, shadcn/ui, QueryClientProvider layout
- [x] 01-02-PLAN.md — TDX security layer: types, mock fixtures, server-only token manager, tdx-api helper, /api/tdx/stations Route Handler
- [x] 01-03-PLAN.md — Vercel deployment: CLI deploy, credential setup docs, end-to-end human verification

### Phase 2: Core Query

**Goal**: 使用者可以選擇起訖站與日期，看到當日所有班次的時刻與座位狀態，並直接點擊前往官方訂票頁
**Depends on**: Phase 1
**Plans**: 4 plans

Plans:
- [x] 02-01-PLAN.md — Backend data layer: extend types, add MOCK_TRAINS fixture, extend tdx-api.ts, create /api/tdx/trains Route Handler (parallel fetch + server-side join)
- [x] 02-02-PLAN.md — Form UI: install shadcn components, taiwan-date utility, SeatBadge, QueryForm with station selects + date picker + swap button
- [x] 02-03-PLAN.md — Result UI: TrainCard (mobile), TrainTable (desktop), TrainList with idle/loading/error/empty states
- [x] 02-04-PLAN.md — Integration + human verification: wire page.tsx with QueryForm + TrainList, end-to-end UI verification

### Phase 3: Secondary Queries

**Goal**: 使用者可透過車次號查詢單一列車停站時刻，亦可查詢特定車站的座位剩餘狀況
**Depends on**: Phase 2
**Plans**: 2 plans

Plans:
- [x] 03-01-PLAN.md — Types/mock/tdx-api extensions + /api/tdx/timetable-by-train Route Handler + ByTrainForm + ByTrainResult
- [x] 03-02-PLAN.md — /api/tdx/seat-status Route Handler + ByStationForm + ByStationResult + page.tsx three-tab integration

### Phase 4: UI Polish

**Goal**: 視覺化車站選擇器取代下拉選單，整體體驗達到 t-ex app 風格的流暢度與可用性
**Depends on**: Phase 3
**Plans**: 1 plan

Plans:
- [x] 04-01-PLAN.md — 視覺化線路圖車站選擇元件（mobile）+ QueryForm 響應式整合

### Phase 5: Shareable URL

**Goal**: 使用者提交查詢後，URL 自動更新含起訖站與日期；他人開啟該連結，頁面自動帶入條件並執行查詢
**Depends on**: Phase 4
**Plans**: 2 plans

Plans:
- [x] 05-01-PLAN.md — SearchParamsInit component + QueryForm optional initial* props
- [x] 05-02-PLAN.md — ShareButton component + page.tsx full URL wiring + next build verification

### Phase 6: Saved Favorite Routes

**Goal**: 使用者可儲存常用起訖站組合，並一鍵帶入查詢表單，資料跨瀏覽器 session 持久化
**Depends on**: Phase 5
**Plans**: 3 plans

Plans:
- [x] 06-01-PLAN.md — Types + SSR-safe useLocalStorage hook + useFavorites domain hook
- [x] 06-02-PLAN.md — FavoriteRouteChips component + QueryForm save button
- [x] 06-03-PLAN.md — page.tsx full wiring + next build verification + human verification

### Phase 7: Round-Trip Query

**Goal**: 使用者可在「來回查詢」分頁選擇起訖站、去程日期與回程日期，同時看到兩段班次並排結果
**Depends on**: Phase 6
**Plans**: 3 plans

Plans:
- [x] 07-01-PLAN.md — RoundTripParams type + RoundTripForm component (station picker + two date pickers with return-date constraint)
- [x] 07-02-PLAN.md — RoundTripResult component (dual parallel React Query with discriminated keys, responsive two-column layout)
- [x] 07-03-PLAN.md — page.tsx fourth tab wiring + next build + human verification

---

## Milestone Summary

**Key Decisions:**
- Server-side TDX token management (server-only guard on tdx-token.ts + tdx-api.ts) — credentials isolated from frontend
- Next.js 16 App Router (not Pages Router) — confirmed correct choice during research
- Tailwind v4 (not v3) — auto-selected by create-next-app@latest with @tailwindcss/postcss
- Mock mode via env var presence (no USE_MOCK_TDX flag) — cleaner config surface
- `page.tsx` marked `use client` — simplest correct approach for form-UI page needing useState
- CSS breakpoints for mobile/desktop swap (md:hidden / hidden md:flex) — avoids hydration mismatch
- `useSearchParams()` isolated in SearchParamsInit child component — always wrapped in Suspense to prevent next build failure
- localStorage hydrated in useEffect with firstLoadDone flag — prevents SSR hydration mismatch
- Saved routes capped at 10 (not 5) — localStorage trivially small; 5 too restrictive for commuters
- Round-trip as fourth tab (not toggle inside existing tab) — cleaner component separation

**Issues Resolved:**
- PTX API → TDX API migration with OAuth2 server-side token caching
- Vue 2 → Next.js full rewrite (archived Vue 2 source in _archive/)
- next build failure mode for useSearchParams (silent in dev, surfaces at build) — resolved via Suspense boundary
- localStorage SSR hydration mismatch — resolved via two-useEffect pattern

**Technical Debt Incurred:**
- RoundTripResult queryKey includes full params object — outbound refetches when only returnDate changes (low severity, correctness unaffected, staleTime=5min). Fix: use ['trains', origin, destination, outboundDate] as outbound key.

---

_For current project status, see .planning/MILESTONES.md_
