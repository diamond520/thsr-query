---
phase: 07-round-trip-query
plan: 03
type: execute
wave: 3
depends_on:
  - "07-01"
  - "07-02"
files_modified:
  - src/app/page.tsx
autonomous: false
requirements:
  - QURY-05

must_haves:
  truths:
    - "Page renders four tabs: 時間 / 車次 / 車站 / 來回 (or equivalent short labels)"
    - "Existing three tabs are unchanged in behavior after the fourth tab is added"
    - "The 來回 tab contains RoundTripForm above RoundTripResult"
    - "Submitting RoundTripForm sets roundTripParams state and triggers RoundTripResult to fetch"
    - "Results appear side-by-side on desktop and stacked on mobile"
    - "next build completes without errors"
  artifacts:
    - path: "src/app/page.tsx"
      provides: "Four-tab page with round-trip query wired"
      contains: "RoundTripForm"
  key_links:
    - from: "src/app/page.tsx"
      to: "src/components/round-trip-form.tsx"
      via: "import RoundTripForm"
      pattern: "import.*RoundTripForm"
    - from: "src/app/page.tsx"
      to: "src/components/round-trip-result.tsx"
      via: "import RoundTripResult"
      pattern: "import.*RoundTripResult"
    - from: "src/app/page.tsx"
      to: "roundTripParams state"
      via: "onSubmit={setRoundTripParams}"
      pattern: "setRoundTripParams|roundTripParams"
---

<objective>
Wire the fourth "來回查詢" tab into page.tsx — add RoundTripForm + RoundTripResult, update TabsList to grid-cols-4 with short labels, then verify end-to-end with next build and human verification.

Purpose: Complete Phase 7 by integrating the new components into the page and confirming the full round-trip user flow works.

Output: Updated `src/app/page.tsx` with four tabs. Human-verified working round-trip query.
</objective>

<execution_context>
@/Users/diamond.hung/.claude/get-shit-done/workflows/execute-plan.md
@/Users/diamond.hung/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-round-trip-query/07-RESEARCH.md
@.planning/phases/07-round-trip-query/07-02-SUMMARY.md
@src/app/page.tsx
@src/types/round-trip.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire fourth tab into page.tsx</name>
  <files>src/app/page.tsx</files>
  <action>
    Edit `src/app/page.tsx` to add the round-trip tab. Make these targeted changes:

    **1. Add imports at the top** (after existing imports):
    ```typescript
    import { RoundTripForm } from '@/components/round-trip-form'
    import { RoundTripResult } from '@/components/round-trip-result'
    import type { RoundTripParams } from '@/types/round-trip'
    ```

    **2. Add state** inside the Home function (after existing state declarations):
    ```typescript
    const [roundTripParams, setRoundTripParams] = useState<RoundTripParams | null>(null)
    ```

    **3. Update TabsList** — change from `grid-cols-3` to `grid-cols-4` and shorten all labels to 2-character Chinese to prevent overflow on 320px viewports:
    ```tsx
    <TabsList className="w-full grid grid-cols-4 mb-4">
      <TabsTrigger value="by-od">時間</TabsTrigger>
      <TabsTrigger value="by-train">車次</TabsTrigger>
      <TabsTrigger value="by-station">車站</TabsTrigger>
      <TabsTrigger value="round-trip">來回</TabsTrigger>
    </TabsList>
    ```

    **4. Add fourth TabsContent** — insert after the closing `</TabsContent>` of the by-station tab:
    ```tsx
    {/* Tab 4: Round-Trip Query (Phase 7) */}
    <TabsContent value="round-trip">
      <div className="mb-6 rounded-lg border bg-card p-4 shadow-sm">
        <RoundTripForm onSubmit={setRoundTripParams} />
      </div>
      <RoundTripResult params={roundTripParams} />
    </TabsContent>
    ```

    **Do NOT modify** any existing tab content, state, handlers, or logic. This is purely additive.

    After editing, run `npx tsc --noEmit` to confirm no TypeScript errors in page.tsx.
  </action>
  <verify>Run `npx tsc --noEmit` — passes. Run `npx next build` — completes without errors. Verify the four tab labels appear (時間 / 車次 / 車站 / 來回) in the source. Confirm existing by-od, by-train, by-station behavior is unchanged.</verify>
  <done>page.tsx has four tabs with grid-cols-4, roundTripParams state wired to RoundTripForm onSubmit and RoundTripResult params, TypeScript compiles cleanly, next build succeeds.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Human verification of round-trip query end-to-end</name>
  <action>Human verifies the complete round-trip query flow works correctly in the browser.</action>
  <verify>All 12 verification steps below pass.</verify>
  <done>User types "approved" confirming four tabs, date constraint, side-by-side results, and booking links all work correctly.</done>
  <what-built>
    Phase 7 complete: Fourth "來回" tab with RoundTripForm (shared station picker + two date pickers with return-date constraint) and RoundTripResult (side-by-side outbound + return train lists). next build succeeded.
  </what-built>
  <how-to-verify>
    Run `npm run dev` and open http://localhost:3000

    1. Verify four tabs appear: 時間 / 車次 / 車站 / 來回
    2. Click the "來回" tab
    3. Select origin (e.g. 南港) and destination (e.g. 台北) — verify station picker works on both mobile and desktop viewports
    4. Select an outbound date — verify it populates correctly
    5. Attempt to select a return date BEFORE the outbound date — verify those dates are grayed out and unselectable
    6. Select a valid return date (same or after outbound date)
    7. Click 查詢 — verify both outbound and return columns appear with loading skeletons, then train results
    8. On mobile viewport (< 768px): verify results stack vertically (outbound above return)
    9. On desktop viewport (>= 768px): verify results appear side-by-side (two columns)
    10. Verify each train row shows: departure time, arrival time, duration, 標準席 badge, 商務席 badge, 去訂票 link
    11. Advance the outbound date past the current return date — verify return date automatically clamps to the new outbound date
    12. Switch back to 時間 tab — verify original single-query behavior is unchanged
  </how-to-verify>
  <resume-signal>Type "approved" if all verification steps pass, or describe any issues found.</resume-signal>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. `npx next build` completes without errors
3. Four tabs render: 時間 / 車次 / 車站 / 來回
4. 來回 tab: station selector works, two date pickers work, return date constrained by outbound date
5. Results: responsive two-column layout (md:grid-cols-2), each leg shows complete train data
6. Existing tabs unmodified
7. Human verified all 12 steps above
</verification>

<success_criteria>
- Four-tab UI with 來回 as fourth tab
- Full round-trip query flow: select stations + dates -> see both legs side-by-side
- Return date picker enforces minimum date constraint
- next build succeeds (no Suspense / SSR issues)
- Human-verified working end-to-end
</success_criteria>

<output>
After completion, create `.planning/phases/07-round-trip-query/07-03-SUMMARY.md` following the summary template.
</output>
