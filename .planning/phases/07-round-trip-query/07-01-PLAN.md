---
phase: 07-round-trip-query
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/types/round-trip.ts
  - src/components/round-trip-form.tsx
autonomous: true
requirements:
  - QURY-05

must_haves:
  truths:
    - "User can select shared origin and destination stations using the existing station picker pattern"
    - "User can select an outbound date via a date picker"
    - "User can select a return date via a separate date picker"
    - "Return date picker disables all dates before the outbound date"
    - "When outbound date advances past the current return date, return date clamps to new outbound date"
    - "Submit button is disabled until origin, destination (not equal), outbound date, and return date are all set"
    - "Submitting the form calls onSubmit with { origin, destination, outboundDate, returnDate }"
  artifacts:
    - path: "src/types/round-trip.ts"
      provides: "RoundTripParams interface"
      contains: "interface RoundTripParams"
    - path: "src/components/round-trip-form.tsx"
      provides: "RoundTripForm component"
      exports: ["RoundTripForm"]
  key_links:
    - from: "src/components/round-trip-form.tsx"
      to: "src/types/round-trip.ts"
      via: "import type RoundTripParams"
      pattern: "import.*RoundTripParams.*round-trip"
    - from: "src/components/round-trip-form.tsx"
      to: "src/components/station-line-picker.tsx"
      via: "StationLinePicker reuse"
      pattern: "StationLinePicker"
---

<objective>
Create the RoundTripParams type and RoundTripForm component — the input half of the round-trip query feature.

Purpose: Users need a form that collects shared station pair plus two independent dates (outbound and return), with the return date constrained to be no earlier than the outbound date.

Output: `src/types/round-trip.ts` (shared type), `src/components/round-trip-form.tsx` (form component)
</objective>

<execution_context>
@/Users/diamond.hung/.claude/get-shit-done/workflows/execute-plan.md
@/Users/diamond.hung/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-round-trip-query/07-RESEARCH.md
@src/components/query-form.tsx
@src/components/station-line-picker.tsx
@src/lib/taiwan-date.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create RoundTripParams type</name>
  <files>src/types/round-trip.ts</files>
  <action>
    Create a new file `src/types/round-trip.ts` exporting the RoundTripParams interface:

    ```typescript
    export interface RoundTripParams {
      origin: string       // TDX StationID e.g. "1"
      destination: string  // TDX StationID e.g. "12"
      outboundDate: string // YYYY-MM-DD format
      returnDate: string   // YYYY-MM-DD format
    }
    ```

    This is a standalone type file — no other imports needed. It will be imported by both RoundTripForm and RoundTripResult.
  </action>
  <verify>File exists at src/types/round-trip.ts and contains the RoundTripParams interface with all four fields.</verify>
  <done>src/types/round-trip.ts exports RoundTripParams with origin, destination, outboundDate, returnDate fields typed as string.</done>
</task>

<task type="auto">
  <name>Task 2: Create RoundTripForm component</name>
  <files>src/components/round-trip-form.tsx</files>
  <action>
    Create `src/components/round-trip-form.tsx` with the following structure. Model after query-form.tsx patterns but adapted for two dates.

    **Imports and structure:**
    - 'use client' directive
    - Import useState, useQuery from react / @tanstack/react-query
    - Import format from date-fns
    - Import ArrowLeftRight, CalendarIcon, Search from lucide-react
    - Import shadcn/ui: Button, Calendar, Popover/PopoverContent/PopoverTrigger, Select/SelectContent/SelectItem/SelectTrigger/SelectValue
    - Import cn from @/lib/utils, getTaiwanToday from @/lib/taiwan-date
    - Import TdxStation from @/types/tdx
    - Import StationLinePicker from @/components/station-line-picker
    - Import RoundTripParams from @/types/round-trip

    **Props interface:**
    ```typescript
    interface RoundTripFormProps {
      onSubmit: (params: RoundTripParams) => void
    }
    ```

    **Local fetchStations function** (same as in query-form.tsx — copy verbatim, do not share to avoid coupling):
    ```typescript
    async function fetchStations(): Promise<TdxStation[]> {
      const res = await fetch('/api/tdx/stations')
      if (!res.ok) throw new Error('Failed to load stations')
      return res.json()
    }
    ```

    **State:**
    - `origin`: string, initialized to ''
    - `destination`: string, initialized to ''
    - `outboundDate`: Date, initialized via `() => getTaiwanToday()` (hydration-safe pattern from query-form.tsx)
    - `returnDate`: Date, initialized via `() => getTaiwanToday()` (same as outbound on first render)
    - `outboundCalendarOpen`: boolean, false
    - `returnCalendarOpen`: boolean, false
    - stations query: `useQuery({ queryKey: ['stations'], queryFn: fetchStations, staleTime: 24 * 60 * 60 * 1000 })`

    **handleSwap:** same as QueryForm — swap origin and destination.

    **handleOutboundDateSelect(d: Date):**
    ```
    setOutboundDate(d)
    setOutboundCalendarOpen(false)
    // Clamp: if return date is before new outbound date, advance return to match
    if (returnDate < d) {
      setReturnDate(d)
    }
    ```

    **handleReturnDateSelect(d: Date):**
    ```
    setReturnDate(d)
    setReturnCalendarOpen(false)
    ```

    **handleSubmit:** prevent default, guard on isValid, call onSubmit with formatted dates using `format(outboundDate, 'yyyy-MM-dd')` and `format(returnDate, 'yyyy-MM-dd')`.

    **isValid:** `!!origin && !!destination && origin !== destination && !!outboundDate && !!returnDate`

    **JSX layout (form with space-y-4):**

    Row 1 — Station selector (mirror query-form.tsx pattern exactly):
    - Mobile (`md:hidden`): StationLinePicker with origin, destination, onOriginChange, onDestinationChange, disabled={stationsLoading}
    - Desktop (`hidden md:flex items-center gap-2`): Select for origin + ArrowLeftRight swap button + Select for destination

    Row 2 — Outbound date picker:
    - Label: `<p className="text-sm font-medium text-muted-foreground">去程日期</p>`
    - Popover with Calendar mode="single", selected={outboundDate}, onSelect={handleOutboundDateSelect}, defaultMonth={outboundDate}
    - Button label: "去程：{format(outboundDate, 'yyyy-MM-dd')}"

    Row 3 — Return date picker:
    - Label: `<p className="text-sm font-medium text-muted-foreground">回程日期</p>`
    - Popover with Calendar mode="single", selected={returnDate}, onSelect={handleReturnDateSelect}, defaultMonth={returnDate}
    - **`disabled={{ before: outboundDate }}`** on the Calendar — react-day-picker v9 DateBefore matcher syntax (NOT fromDate/toDate — those were removed in v9)
    - Button label: "回程：{format(returnDate, 'yyyy-MM-dd')}"

    Row 4 — Submit button (full width, disabled when !isValid):
    - `<Search className="mr-2 h-4 w-4" />查詢`
  </action>
  <verify>Run `npx tsc --noEmit` from the project root — no TypeScript errors in round-trip-form.tsx. Also verify the file renders without runtime errors by checking it compiles cleanly.</verify>
  <done>src/components/round-trip-form.tsx exports RoundTripForm, compiles without TypeScript errors, and implements: shared station selector (mobile line picker + desktop selects), two independent date pickers with return constrained to disabled={{ before: outboundDate }}, outbound date clamping when return date would become invalid, submit calls onSubmit(RoundTripParams).</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors related to round-trip-form.tsx or round-trip.ts
2. src/types/round-trip.ts exports RoundTripParams interface with exactly four string fields
3. src/components/round-trip-form.tsx exports RoundTripForm accepting `onSubmit: (params: RoundTripParams) => void`
4. Calendar for return date has `disabled={{ before: outboundDate }}` (v9 syntax, not fromDate/toDate)
5. handleOutboundDateSelect clamps returnDate when it would precede new outbound date
</verification>

<success_criteria>
- RoundTripParams type exists and is well-typed
- RoundTripForm renders station selector (mobile line picker + desktop selects), two date pickers, submit button
- Return date picker correctly prevents selection of dates before outbound date
- TypeScript compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/07-round-trip-query/07-01-SUMMARY.md` following the summary template.
</output>
