---
phase: 05-shareable-url
plan: 02
type: execute
wave: 2
depends_on:
  - 05-01
files_modified:
  - src/components/share-button.tsx
  - src/app/page.tsx
autonomous: true
requirements:
  - SHAR-01

must_haves:
  truths:
    - "Submitting the by-OD query form updates the browser URL to ?from=<StationID>&to=<StationID>&date=<YYYY-MM-DD> without a page reload"
    - "Opening a URL with valid ?from, ?to, ?date params pre-fills the query form and immediately executes the query"
    - "A share button appears after a query is submitted and allows copying or sharing the current URL"
    - "next build completes without errors (Suspense boundary correctly wraps SearchParamsInit)"
  artifacts:
    - path: "src/components/share-button.tsx"
      provides: "Share/copy button using Web Share API with clipboard fallback; renders null when params is null"
      exports: ["ShareButton"]
    - path: "src/app/page.tsx"
      provides: "Full wiring: Suspense+SearchParamsInit, router.replace on submit, formKey remount pattern, ShareButton render"
      contains: "Suspense fallback={null}"
  key_links:
    - from: "src/app/page.tsx"
      to: "src/components/search-params-init.tsx"
      via: "Suspense wrapping SearchParamsInit"
      pattern: "<Suspense fallback=\\{null\\}>"
    - from: "src/app/page.tsx"
      to: "router.replace"
      via: "handleQuerySubmit calls router.replace with ?from=&to=&date= after setting queryParams"
      pattern: "router\\.replace"
    - from: "src/app/page.tsx"
      to: "src/components/query-form.tsx"
      via: "key={formKey} prop forces remount when URL params arrive"
      pattern: "key=\\{formKey\\}"
    - from: "src/components/share-button.tsx"
      to: "navigator.share / navigator.clipboard"
      via: "handleShare onClick"
      pattern: "navigator\\.share|navigator\\.clipboard"
---

<objective>
Wire all Phase 5 features into page.tsx: create ShareButton component, add Suspense+SearchParamsInit for URL-to-form pre-fill, add router.replace for URL updates on submit, and verify the production build passes.

Purpose: This plan completes the shareable URL feature end-to-end. Plan 01 created the building blocks; this plan assembles them.
Output: share-button.tsx (new), page.tsx (updated with full wiring), next build passes
</objective>

<execution_context>
@/Users/diamond.hung/.claude/get-shit-done/workflows/execute-plan.md
@/Users/diamond.hung/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@src/app/page.tsx
@src/components/query-form.tsx
@.planning/phases/05-shareable-url/05-RESEARCH.md
@.planning/phases/05-shareable-url/05-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ShareButton component</name>
  <files>src/components/share-button.tsx</files>
  <action>
Create `src/components/share-button.tsx` with Web Share API and clipboard fallback:

```typescript
// src/components/share-button.tsx
'use client'

import { useState } from 'react'
import { Share2, Copy, Check } from 'lucide-react'
import { Button } from '@/components/ui/button'
import type { QueryParams } from '@/components/query-form'

interface ShareButtonProps {
  params: QueryParams | null
}

export function ShareButton({ params }: ShareButtonProps) {
  const [copied, setCopied] = useState(false)

  // Render nothing when no query has been submitted yet
  if (!params) return null

  async function handleShare() {
    const url = window.location.href  // URL already updated by router.replace() before this renders

    // Try Web Share API first (mobile native share sheet — iOS Safari, Android Chrome)
    // Guard: check typeof navigator for SSR safety (button is client-only but belt-and-suspenders)
    if (
      typeof navigator !== 'undefined' &&
      navigator.share &&
      navigator.canShare({ url })
    ) {
      try {
        await navigator.share({ title: '高鐵查詢', url })
        return  // share sheet handled it — no clipboard needed
      } catch (e) {
        // User cancelled (AbortError) → do nothing; other errors → fall through to clipboard
        if ((e as DOMException).name === 'AbortError') return
      }
    }

    // Fallback: copy URL to clipboard
    try {
      await navigator.clipboard.writeText(url)
      setCopied(true)
      setTimeout(() => setCopied(false), 2000)
    } catch {
      // Clipboard API unavailable (non-HTTPS or permission denied) — fail silently
    }
  }

  return (
    <Button variant="outline" size="sm" onClick={handleShare}>
      {copied
        ? <Check className="h-4 w-4 mr-1" />
        : <Share2 className="h-4 w-4 mr-1" />
      }
      {copied ? '已複製' : '分享'}
    </Button>
  )
}
```

Implementation notes:
- `navigator.canShare({ url })` is called before `navigator.share()` — not all browsers that expose `navigator.share` can share URLs (some only support files); `canShare` guard prevents runtime errors
- `AbortError` on share cancellation is a valid user action, not an error — return silently without showing "copied"
- The clipboard fallback `setCopied(true)` gives 2-second visual confirmation of the copy — matches common UX patterns
- `window.location.href` is used (not `window.location.origin + pathname + search`) because router.replace() has already updated the full URL by the time the user sees and clicks the button
- Importing `QueryParams` type from query-form.tsx (not re-declaring it) ensures type safety without duplication
  </action>
  <verify>
Run `npx tsc --noEmit` and confirm no TypeScript errors for the new file.
  </verify>
  <done>src/components/share-button.tsx exists, exports ShareButton, renders null when params is null, uses Web Share API with clipboard fallback, and compiles without TypeScript errors.</done>
</task>

<task type="auto">
  <name>Task 2: Wire page.tsx and verify next build</name>
  <files>src/app/page.tsx</files>
  <action>
Rewrite `src/app/page.tsx` to add all Phase 5 wiring. The page is already `'use client'` and has the three-tab structure — this task adds URL state management on top of the existing structure.

**Full updated page.tsx:**

```typescript
'use client'

import { Suspense, useState } from 'react'
import { useRouter, usePathname } from 'next/navigation'
import { QueryForm, QueryParams } from '@/components/query-form'
import { TrainList } from '@/components/train-list'
import { ByTrainForm } from '@/components/by-train-form'
import { ByTrainResult } from '@/components/by-train-result'
import { ByStationForm } from '@/components/by-station-form'
import { ByStationResult } from '@/components/by-station-result'
import { Tabs, TabsList, TabsTrigger, TabsContent } from '@/components/ui/tabs'
import { SearchParamsInit } from '@/components/search-params-init'
import { ShareButton } from '@/components/share-button'

export default function Home() {
  const router = useRouter()
  const pathname = usePathname()

  // by-od state
  const [queryParams, setQueryParams] = useState<QueryParams | null>(null)

  // URL → form pre-fill state (set by SearchParamsInit on mount)
  const [initialOrigin, setInitialOrigin] = useState<string | undefined>()
  const [initialDestination, setInitialDestination] = useState<string | undefined>()
  const [initialDate, setInitialDate] = useState<string | undefined>()
  // formKey: increment to force QueryForm remount — picks up new initial* prop values
  const [formKey, setFormKey] = useState(0)

  // by-train state
  const [trainNo, setTrainNo] = useState<string | null>(null)

  // by-station state
  const [stationId, setStationId] = useState<string | null>(null)

  // Called once on mount by SearchParamsInit when URL has ?from, ?to, ?date params
  function handleParamInit(from: string | null, to: string | null, date: string | null) {
    if (from) setInitialOrigin(from)
    if (to) setInitialDestination(to)
    if (date) setInitialDate(date)
    // Remount QueryForm so useState initializers pick up the new initial* props
    setFormKey(k => k + 1)
    // Auto-execute the query when all three params are present
    if (from && to && date) {
      setQueryParams({ origin: from, destination: to, date })
    }
  }

  // Called by QueryForm onSubmit — sets query state AND updates URL
  function handleQuerySubmit(params: QueryParams) {
    setQueryParams(params)

    // Update URL without page reload or new history entry (no Back-button loop)
    const urlParams = new URLSearchParams({
      from: params.origin,
      to: params.destination,
      date: params.date,
    })
    router.replace(`${pathname}?${urlParams.toString()}`, { scroll: false })
  }

  return (
    <main className="min-h-screen bg-background">
      {/*
        SearchParamsInit reads URL params on mount and calls handleParamInit.
        Suspense boundary is REQUIRED for next build production prerendering —
        useSearchParams() without Suspense causes a silent build failure.
        fallback={null} avoids any layout shift (SearchParamsInit renders nothing).
      */}
      <Suspense fallback={null}>
        <SearchParamsInit onInit={handleParamInit} />
      </Suspense>

      <div className="mx-auto max-w-2xl px-4 py-8">
        {/* Page header */}
        <div className="mb-6">
          <h1 className="text-2xl font-bold tracking-tight">高鐵查詢</h1>
          <p className="text-muted-foreground text-sm mt-1">查詢班次時刻與座位狀態</p>
        </div>

        {/* Top-level mode switcher */}
        <Tabs defaultValue="by-od" className="w-full">
          <TabsList className="w-full grid grid-cols-3 mb-4">
            <TabsTrigger value="by-od">時間查詢</TabsTrigger>
            <TabsTrigger value="by-train">車次查詢</TabsTrigger>
            <TabsTrigger value="by-station">車站查詢</TabsTrigger>
          </TabsList>

          {/* Tab 1: By OD — Phase 5 adds URL wiring + ShareButton */}
          <TabsContent value="by-od">
            <div className="mb-6 rounded-lg border bg-card p-4 shadow-sm">
              {/*
                key={formKey}: when formKey increments (triggered by URL params on load),
                React unmounts and remounts QueryForm so useState initializers run again
                with the new initial* props from the URL.
              */}
              <QueryForm
                key={formKey}
                initialOrigin={initialOrigin}
                initialDestination={initialDestination}
                initialDate={initialDate}
                onSubmit={handleQuerySubmit}
              />
            </div>
            {/* ShareButton renders only when a query has been submitted (queryParams !== null) */}
            {queryParams && (
              <div className="mb-4 flex justify-end">
                <ShareButton params={queryParams} />
              </div>
            )}
            <TrainList params={queryParams} />
          </TabsContent>

          {/* Tab 2: By Train Number (Phase 3 — unchanged) */}
          <TabsContent value="by-train">
            <div className="mb-2 rounded-lg border bg-card p-4 shadow-sm">
              <ByTrainForm onSubmit={setTrainNo} />
            </div>
            <ByTrainResult trainNo={trainNo} />
          </TabsContent>

          {/* Tab 3: By Station (Phase 3 — unchanged) */}
          <TabsContent value="by-station">
            <div className="mb-2 rounded-lg border bg-card p-4 shadow-sm">
              <ByStationForm onSubmit={setStationId} />
            </div>
            <ByStationResult stationId={stationId} />
          </TabsContent>
        </Tabs>
      </div>
    </main>
  )
}
```

**Key implementation details:**

1. **Suspense placement**: `<Suspense fallback={null}>` is placed OUTSIDE the `<div className="mx-auto...">` container and BEFORE it in the JSX tree. This ensures the boundary wraps only the SearchParamsInit effect component, with no impact on visible layout. The `fallback={null}` produces zero layout shift since SearchParamsInit has no visual output.

2. **router.replace with { scroll: false }**: Prevents Next.js from scrolling to the top of the page after URL update — the user just submitted a form and the results appear below; scroll preservation is critical UX.

3. **formKey increment pattern**: `setFormKey(k => k + 1)` in handleParamInit forces QueryForm to remount with the new initial* props. This is the only correct way to reset useState values from new props (useState ignores prop changes after mount). The key only increments once (on mount when URL params are detected), not on every render.

4. **Auto-execute query**: `if (from && to && date) setQueryParams(...)` in handleParamInit automatically triggers the query when all three params are present in the URL. This satisfies success criterion #2 (open link → immediate results).

5. **ShareButton placement**: Rendered between the QueryForm card and TrainList, right-aligned (`flex justify-end`). Only shows when `queryParams !== null`, which happens after the first form submit OR after URL params trigger handleParamInit.

6. **Backward compatibility**: By-train and By-station tabs (Tab 2, Tab 3) are completely unchanged.

After writing the file, run:
```bash
npm run build
```

The build MUST succeed with zero errors. Specifically watch for any `useSearchParams` Suspense boundary errors (they appear as build-time errors, not runtime errors in dev).
  </action>
  <verify>
Run `npm run build` from the project root. Confirm:
1. Build exits with code 0 (no errors)
2. No "Missing Suspense boundary" or "useSearchParams" warnings/errors in build output
3. Run `npx tsc --noEmit` separately to confirm clean TypeScript as well
  </verify>
  <done>
- page.tsx imports and wires SearchParamsInit, ShareButton, useRouter, usePathname
- Suspense wraps SearchParamsInit with fallback={null}
- handleParamInit sets initial* state + increments formKey + auto-triggers query
- handleQuerySubmit calls router.replace with ?from=&to=&date= and { scroll: false }
- QueryForm receives key={formKey}, initialOrigin, initialDestination, initialDate props
- ShareButton renders only when queryParams is non-null
- `npm run build` exits with code 0 and zero Suspense/useSearchParams errors
  </done>
</task>

</tasks>

<verification>
Run in order:
1. `npx tsc --noEmit` — zero TypeScript errors
2. `npm run build` — exits code 0, no Suspense boundary errors in output

Manual smoke test (optional, covered by checkpoint in this plan):
- Start `npm run dev`
- Navigate to `http://localhost:3000/?from=1&to=12&date=2026-02-20`
- Expected: form pre-fills 南港→左營, date 2026-02-20, query executes automatically
- Submit a different query, observe URL updates in address bar
- Click 分享 button, observe clipboard copy or share sheet
</verification>

<success_criteria>
- src/components/share-button.tsx exists and exports ShareButton
- src/app/page.tsx has Suspense wrapping SearchParamsInit
- src/app/page.tsx has router.replace call in handleQuerySubmit
- src/app/page.tsx passes key={formKey} and initial* props to QueryForm
- src/app/page.tsx renders ShareButton below QueryForm when queryParams is non-null
- `npm run build` exits with code 0
- No TypeScript errors (`npx tsc --noEmit`)
</success_criteria>

<output>
After completion, create `.planning/phases/05-shareable-url/05-02-SUMMARY.md` following the summary template.
</output>
