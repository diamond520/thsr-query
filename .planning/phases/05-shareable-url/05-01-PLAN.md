---
phase: 05-shareable-url
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/search-params-init.tsx
  - src/components/query-form.tsx
autonomous: true
requirements:
  - SHAR-01

must_haves:
  truths:
    - "SearchParamsInit component exists and calls useSearchParams() inside a 'use client' component that renders null"
    - "QueryForm accepts optional initialOrigin, initialDestination, initialDate props and uses them as useState initializers"
  artifacts:
    - path: "src/components/search-params-init.tsx"
      provides: "Effect-only component that reads ?from, ?to, ?date from URL and fires onInit callback on mount"
      exports: ["SearchParamsInit"]
    - path: "src/components/query-form.tsx"
      provides: "QueryForm with optional initial* props consumed by useState initializers"
      exports: ["QueryForm", "QueryParams"]
  key_links:
    - from: "src/components/search-params-init.tsx"
      to: "onInit callback"
      via: "useEffect on mount with empty dep array"
      pattern: "useEffect\\(\\(\\) => \\{"
    - from: "src/components/query-form.tsx"
      to: "useState initializers"
      via: "initialOrigin ?? '', initialDestination ?? '', initialDate ? new Date(initialDate + 'T00:00:00') : getTaiwanToday()"
      pattern: "initialOrigin \\?\\?"
---

<objective>
Create the two building blocks required for URL-to-form pre-fill: the SearchParamsInit effect component (reads URL params on mount) and QueryForm prop extensions (accepts initial values that useState picks up on remount).

Purpose: Plan 02 will wire these into page.tsx. Both components must exist first so page.tsx has the correct import targets and prop shapes to depend on.
Output: search-params-init.tsx (new file), query-form.tsx (updated props interface + useState initializers)
</objective>

<execution_context>
@/Users/diamond.hung/.claude/get-shit-done/workflows/execute-plan.md
@/Users/diamond.hung/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@src/components/query-form.tsx
@.planning/phases/05-shareable-url/05-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SearchParamsInit component</name>
  <files>src/components/search-params-init.tsx</files>
  <action>
Create a new file `src/components/search-params-init.tsx` with the following implementation:

```typescript
// src/components/search-params-init.tsx
'use client'

import { useEffect } from 'react'
import { useSearchParams } from 'next/navigation'

interface SearchParamsInitProps {
  onInit: (from: string | null, to: string | null, date: string | null) => void
}

export function SearchParamsInit({ onInit }: SearchParamsInitProps) {
  const searchParams = useSearchParams()

  useEffect(() => {
    const from = searchParams.get('from')
    const to = searchParams.get('to')
    const date = searchParams.get('date')
    // Only fire if at least one param is present — avoids spurious init on clean load
    if (from || to || date) {
      onInit(from, to, date)
    }
  }, []) // empty dep array — run once on mount only

  return null
}
```

Key implementation notes:
- The `'use client'` directive is mandatory — `useSearchParams()` is a client-only hook
- This component renders `null` — it is an effect-only component; it has no visual output
- The empty dep array `[]` in useEffect ensures it fires once on mount only, not on every render
- The `if (from || to || date)` guard prevents calling `onInit` on clean page loads where no URL params exist, which would force a needless QueryForm remount (via formKey increment in page.tsx)
- The `onInit` callback is NOT in the dependency array intentionally — adding it would risk infinite loops if the parent re-renders; the effect is mount-only
- This component is designed to be wrapped in `<Suspense fallback={null}>` in page.tsx (done in Plan 02) — the Suspense wrapping is what satisfies `next build`'s production prerendering requirement
  </action>
  <verify>
Run `npx tsc --noEmit` from the project root and confirm no TypeScript errors are reported for the new file.
  </verify>
  <done>src/components/search-params-init.tsx exists, exports SearchParamsInit, and TypeScript compiles without errors.</done>
</task>

<task type="auto">
  <name>Task 2: Extend QueryForm with optional initial* props</name>
  <files>src/components/query-form.tsx</files>
  <action>
Update `src/components/query-form.tsx` to add three optional props to `QueryFormProps` and update the `useState` initializers to consume them. All changes are backward-compatible (props are optional with defaults matching current behavior).

**Step 1 — Update the `QueryFormProps` interface:**

Change:
```typescript
interface QueryFormProps {
  onSubmit: (params: QueryParams) => void
}
```

To:
```typescript
interface QueryFormProps {
  onSubmit: (params: QueryParams) => void
  initialOrigin?: string
  initialDestination?: string
  initialDate?: string  // YYYY-MM-DD string format
}
```

**Step 2 — Update the function signature to destructure the new props:**

Change:
```typescript
export function QueryForm({ onSubmit }: QueryFormProps) {
```

To:
```typescript
export function QueryForm({ onSubmit, initialOrigin, initialDestination, initialDate }: QueryFormProps) {
```

**Step 3 — Update the three `useState` initializers to consume the new props:**

Change:
```typescript
  const [origin, setOrigin] = useState<string>('')
  const [destination, setDestination] = useState<string>('')
  // getTaiwanToday() called inside useState initializer — avoids hydration mismatch
  const [date, setDate] = useState<Date>(() => getTaiwanToday())
```

To:
```typescript
  const [origin, setOrigin] = useState<string>(initialOrigin ?? '')
  const [destination, setDestination] = useState<string>(initialDestination ?? '')
  // getTaiwanToday() called inside useState initializer — avoids hydration mismatch
  // initialDate parsed with explicit T00:00:00 to force local-time interpretation (not UTC midnight)
  const [date, setDate] = useState<Date>(() =>
    initialDate ? new Date(initialDate + 'T00:00:00') : getTaiwanToday()
  )
```

**No other changes to query-form.tsx** — the rest of the component (StationLinePicker, Select, date picker, submit button, handleSubmit, handleSwap) remains completely unchanged.

**Why `initialDate + 'T00:00:00'`:**  Per the existing pattern comment in the file, `getTaiwanToday()` avoids hydration issues by running inside the useState initializer. Parsing `new Date('2026-01-01')` (no time component) treats the string as UTC midnight, which would display as 2025-12-31 in UTC+8 timezones. Appending `'T00:00:00'` forces local-time interpretation, consistent with the existing `format(date, 'yyyy-MM-dd')` call in handleSubmit.
  </action>
  <verify>
Run `npx tsc --noEmit` and confirm no TypeScript errors. Also verify that calling `<QueryForm onSubmit={fn} />` (no initial props) still compiles correctly — the props are optional with `??` defaults, so existing usage is unaffected.
  </verify>
  <done>QueryFormProps has three new optional fields (initialOrigin?, initialDestination?, initialDate?), the function destructures them, and all three useState initializers fall back to the existing default behavior when props are absent. TypeScript compiles without errors.</done>
</task>

</tasks>

<verification>
Run `npx tsc --noEmit` from project root. Zero TypeScript errors expected.
</verification>

<success_criteria>
- src/components/search-params-init.tsx exists, exports SearchParamsInit, compiles cleanly
- src/components/query-form.tsx QueryFormProps has initialOrigin?, initialDestination?, initialDate? props
- QueryForm useState initializers use new props with correct fallback defaults
- No TypeScript errors
- Existing QueryForm usage (onSubmit only) is backward-compatible
</success_criteria>

<output>
After completion, create `.planning/phases/05-shareable-url/05-01-SUMMARY.md` following the summary template.
</output>
