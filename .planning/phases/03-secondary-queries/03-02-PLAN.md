---
phase: 03-secondary-queries
plan: 02
type: execute
wave: 2
depends_on:
  - "03-01"
files_modified:
  - src/app/api/tdx/seat-status/route.ts
  - src/components/by-station-form.tsx
  - src/components/by-station-result.tsx
  - src/app/page.tsx
autonomous: true
requirements:
  - QURY-03

must_haves:
  truths:
    - "頁面頂端顯示三個分頁標籤：時間查詢、車次查詢、車站查詢"
    - "時間查詢分頁保留 Phase 2 的 QueryForm + TrainList，行為不變"
    - "車次查詢分頁嵌入 Plan 01 的 ByTrainForm + ByTrainResult"
    - "使用者在車站查詢分頁選擇車站後，頁面顯示該站的北上與南下班次，各附座位狀態"
    - "車站查詢有 loading 骨架、查無資料、API 錯誤三種對應畫面"
    - "北上/南下以 shadcn Tabs 分頁顯示，預設顯示北上"
  artifacts:
    - path: "src/app/api/tdx/seat-status/route.ts"
      provides: "GET /api/tdx/seat-status?stationId= returns TdxStationSeatStatus"
      contains: "export const dynamic = 'force-dynamic'"
    - path: "src/components/by-station-form.tsx"
      provides: "Station select (reusing TdxStation list) + submit"
    - path: "src/components/by-station-result.tsx"
      provides: "Northbound/southbound Tabs with SeatBadge per train"
    - path: "src/app/page.tsx"
      provides: "Top-level mode Tabs wrapping all three query modes"
      contains: "by-od.*by-train.*by-station"
  key_links:
    - from: "src/components/by-station-form.tsx"
      to: "src/components/by-station-result.tsx"
      via: "stationId state passed as prop"
      pattern: "stationId.*string"
    - from: "src/components/by-station-result.tsx"
      to: "/api/tdx/seat-status"
      via: "useQuery fetch in React Query hook"
      pattern: "fetch.*seat-status"
    - from: "src/app/api/tdx/seat-status/route.ts"
      to: "src/lib/tdx-api.ts"
      via: "fetchSeatStatus(stationId) — same function as Phase 2"
      pattern: "fetchSeatStatus"
    - from: "src/app/page.tsx"
      to: "src/components/by-train-form.tsx + by-train-result.tsx + by-station-form.tsx + by-station-result.tsx"
      via: "shadcn Tabs with TabsContent per mode"
      pattern: "TabsContent"
---

<objective>
Build the by-station query feature and integrate all three query modes into page.tsx via top-level shadcn Tabs.

Purpose: Completes Phase 3 by adding the by-station Route Handler, display components, and the mode-switcher Tabs that unify the full query experience. Phase 2's QueryForm + TrainList must be preserved unchanged inside the by-od tab.
Output: Working `/api/tdx/seat-status` Route Handler, `ByStationForm`, `ByStationResult` components, and updated `page.tsx` with three-tab mode switching.
</objective>

<execution_context>
@/Users/diamond.hung/.claude/get-shit-done/workflows/execute-plan.md
@/Users/diamond.hung/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-secondary-queries/03-RESEARCH.md
@.planning/phases/03-secondary-queries/03-01-SUMMARY.md
@src/types/tdx.ts
@src/fixtures/tdx-mock.ts
@src/lib/tdx-api.ts
@src/app/page.tsx
@src/components/seat-badge.tsx
@src/components/query-form.tsx
@src/app/api/tdx/trains/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: By-station Route Handler and display components</name>
  <files>
    src/app/api/tdx/seat-status/route.ts
    src/components/by-station-form.tsx
    src/components/by-station-result.tsx
  </files>
  <action>
**Step 1 — Create `src/app/api/tdx/seat-status/route.ts`:**

```typescript
// GET /api/tdx/seat-status?stationId=<StationID>
// Returns TdxStationSeatStatus = { northbound: TdxSeatStatus[], southbound: TdxSeatStatus[] }
// Direction split is done server-side: 0=southbound (南下), 1=northbound (北上).
// Uses force-dynamic: seat status changes every ~10 minutes.

import { isMockMode, fetchSeatStatus } from '@/lib/tdx-api'
import { MOCK_SEAT_STATUS_BY_STATION } from '@/fixtures/tdx-mock'
import { NextResponse } from 'next/server'

export const dynamic = 'force-dynamic'  // Seat status is real-time data

export async function GET(request: Request) {
  const { searchParams } = new URL(request.url)
  const stationId = searchParams.get('stationId')

  if (!stationId) {
    return NextResponse.json(
      { error: 'Missing required parameter: stationId' },
      { status: 400 }
    )
  }

  if (isMockMode()) {
    return NextResponse.json(MOCK_SEAT_STATUS_BY_STATION)
  }

  try {
    const trains = await fetchSeatStatus(stationId)
    // Split by Direction server-side — do NOT return raw array to client
    // Direction: 0 = southbound (南下), 1 = northbound (北上) — per TdxSeatStatus type comment
    const northbound = trains.filter(t => t.Direction === 1)
    const southbound = trains.filter(t => t.Direction === 0)
    return NextResponse.json({ northbound, southbound })
  } catch (error) {
    console.error('[/api/tdx/seat-status] Error:', error)
    return NextResponse.json(
      { error: 'Failed to fetch seat status from TDX' },
      { status: 502 }
    )
  }
}
```

**Step 2 — Create `src/components/by-station-form.tsx`:**

Pattern follows query-form.tsx: fetches station list via React Query, uses shadcn Select, emits stationId on submit.

```tsx
// src/components/by-station-form.tsx
// Station select for by-station seat status query.
// Fetches station list from /api/tdx/stations (same as QueryForm — shared cache via queryKey).
// Emits stationId string to parent via onSubmit.
'use client'

import { useState } from 'react'
import { Search } from 'lucide-react'
import { useQuery } from '@tanstack/react-query'
import { Button } from '@/components/ui/button'
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select'
import type { TdxStation } from '@/types/tdx'

interface ByStationFormProps {
  onSubmit: (stationId: string) => void
}

async function fetchStations(): Promise<TdxStation[]> {
  const res = await fetch('/api/tdx/stations')
  if (!res.ok) throw new Error('Failed to load stations')
  return res.json()
}

export function ByStationForm({ onSubmit }: ByStationFormProps) {
  const [stationId, setStationId] = useState('')

  const { data: stations = [], isLoading: stationsLoading } = useQuery({
    queryKey: ['stations'],   // Same key as QueryForm — reuses cached data
    queryFn: fetchStations,
    staleTime: 24 * 60 * 60 * 1000,  // 24h
  })

  function handleSubmit(e: React.FormEvent) {
    e.preventDefault()
    if (!stationId) return
    onSubmit(stationId)
  }

  return (
    <form onSubmit={handleSubmit} className="space-y-3">
      <div className="space-y-1.5">
        <Select value={stationId} onValueChange={setStationId} disabled={stationsLoading}>
          <SelectTrigger className="w-full max-w-[240px]">
            <SelectValue placeholder="選擇車站" />
          </SelectTrigger>
          <SelectContent>
            {stations.map(station => (
              <SelectItem key={station.StationID} value={station.StationID}>
                {station.StationName.Zh_tw}
              </SelectItem>
            ))}
          </SelectContent>
        </Select>
      </div>
      <Button type="submit" disabled={!stationId || stationsLoading}>
        <Search className="mr-2 h-4 w-4" />
        查詢
      </Button>
    </form>
  )
}
```

**Step 3 — Create `src/components/by-station-result.tsx`:**

Uses shadcn Tabs (installed in Plan 01) for North/South split. Reuses SeatBadge. Handles idle/loading/error/empty states.

```tsx
// src/components/by-station-result.tsx
// Displays seat availability at a station, split into northbound (北上) / southbound (南下) tabs.
// Reuses SeatBadge from Phase 2. Tabs installed in Plan 01.
'use client'

import { useQuery } from '@tanstack/react-query'
import { Skeleton } from '@/components/ui/skeleton'
import { Tabs, TabsList, TabsTrigger, TabsContent } from '@/components/ui/tabs'
import { SeatBadge } from '@/components/seat-badge'
import type { TdxSeatStatus, TdxStationSeatStatus } from '@/types/tdx'

interface ByStationResultProps {
  stationId: string | null   // null = idle
}

async function fetchStationSeatStatus(stationId: string): Promise<TdxStationSeatStatus> {
  const res = await fetch(`/api/tdx/seat-status?stationId=${encodeURIComponent(stationId)}`)
  if (!res.ok) {
    const body = await res.json().catch(() => ({}))
    throw new Error(body.error ?? `HTTP ${res.status}`)
  }
  return res.json()
}

function TrainSeatRow({ train, stationId }: { train: TdxSeatStatus; stationId: string }) {
  // Find the stop that matches the queried station to get seat status at this leg
  const stop = train.StopStations.find(s => s.StationID === stationId)

  return (
    <div className="flex items-center gap-4 px-4 py-3">
      <span className="text-sm font-medium w-12 shrink-0 tabular-nums">{train.TrainNo}</span>
      <div className="flex gap-3">
        <SeatBadge status={stop?.StandardSeatStatus ?? null} type="標準席" />
        <SeatBadge status={stop?.BusinessSeatStatus ?? null} type="商務席" />
      </div>
    </div>
  )
}

function TrainList({ trains, stationId, direction }: { trains: TdxSeatStatus[]; stationId: string; direction: string }) {
  if (trains.length === 0) {
    return (
      <div className="px-4 py-8 text-center text-sm text-muted-foreground">
        目前無{direction}班次資料
      </div>
    )
  }
  return (
    <div className="divide-y">
      {trains.map(train => (
        <TrainSeatRow key={train.TrainNo} train={train} stationId={stationId} />
      ))}
    </div>
  )
}

export function ByStationResult({ stationId }: ByStationResultProps) {
  const { data, isLoading, isError, error } = useQuery({
    queryKey: ['seat-status-by-station', stationId],
    queryFn: () => fetchStationSeatStatus(stationId!),
    enabled: !!stationId,
    staleTime: 10 * 60 * 1000,   // 10 min — seat status changes every ~10 min
    retry: 1,
  })

  // Idle
  if (!stationId) return null

  // Loading
  if (isLoading) {
    return (
      <div className="space-y-2 mt-4">
        {Array.from({ length: 5 }).map((_, i) => (
          <Skeleton key={i} className="h-12 w-full rounded-md" />
        ))}
      </div>
    )
  }

  // Error
  if (isError) {
    return (
      <div className="mt-4 rounded-md border border-destructive/30 bg-destructive/5 px-4 py-3 text-sm text-destructive">
        無法取得座位狀態：{error instanceof Error ? error.message : '未知錯誤'}
      </div>
    )
  }

  if (!data) return null

  return (
    <div className="mt-4 rounded-lg border bg-card shadow-sm overflow-hidden">
      <div className="px-4 py-3 border-b bg-muted/30">
        <p className="text-sm font-medium">座位剩餘狀態</p>
        <p className="text-xs text-muted-foreground mt-0.5">
          北上 {data.northbound.length} 班 · 南下 {data.southbound.length} 班
        </p>
      </div>
      <Tabs defaultValue="northbound" className="w-full">
        <TabsList className="w-full grid grid-cols-2 rounded-none border-b h-10">
          <TabsTrigger value="northbound" className="rounded-none">
            北上（{data.northbound.length}）
          </TabsTrigger>
          <TabsTrigger value="southbound" className="rounded-none">
            南下（{data.southbound.length}）
          </TabsTrigger>
        </TabsList>
        <TabsContent value="northbound" className="mt-0">
          <TrainList trains={data.northbound} stationId={stationId} direction="北上" />
        </TabsContent>
        <TabsContent value="southbound" className="mt-0">
          <TrainList trains={data.southbound} stationId={stationId} direction="南下" />
        </TabsContent>
      </Tabs>
    </div>
  )
}
```
  </action>
  <verify>
1. Run `npx tsc --noEmit` — 0 errors.
2. Run `npm run dev` and `curl "http://localhost:3000/api/tdx/seat-status?stationId=2"` — returns JSON with shape `{ "northbound": [...], "southbound": [...] }`.
3. `curl "http://localhost:3000/api/tdx/seat-status"` — returns 400 with error JSON.
  </verify>
  <done>
`npx tsc --noEmit` exits 0. The three new files exist. `/api/tdx/seat-status?stationId=2` returns `{"northbound":[...],"southbound":[...]}`. `ByStationResult` and `ByStationForm` components import without errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate all three modes into page.tsx with top-level Tabs</name>
  <files>
    src/app/page.tsx
  </files>
  <action>
Replace the entire contents of `src/app/page.tsx`. The existing Phase 2 QueryForm + TrainList must be preserved unchanged inside the by-od TabsContent.

Key decisions:
- `page.tsx` remains `'use client'` (already is)
- Top-level shadcn Tabs wraps all three modes; `defaultValue="by-od"` so Phase 2 behavior is unchanged on load
- Each tab has its own local state managed within page.tsx using `useState`
- The card wrapper (`rounded-lg border bg-card p-4 shadow-sm`) moves inside each tab's form section
- ByTrainResult and ByStationResult are rendered outside the card (they have their own card-style container)

```tsx
'use client'

import { useState } from 'react'
import { QueryForm, QueryParams } from '@/components/query-form'
import { TrainList } from '@/components/train-list'
import { ByTrainForm } from '@/components/by-train-form'
import { ByTrainResult } from '@/components/by-train-result'
import { ByStationForm } from '@/components/by-station-form'
import { ByStationResult } from '@/components/by-station-result'
import { Tabs, TabsList, TabsTrigger, TabsContent } from '@/components/ui/tabs'

export default function Home() {
  // by-od state (Phase 2 — unchanged)
  const [queryParams, setQueryParams] = useState<QueryParams | null>(null)

  // by-train state
  const [trainNo, setTrainNo] = useState<string | null>(null)

  // by-station state
  const [stationId, setStationId] = useState<string | null>(null)

  return (
    <main className="min-h-screen bg-background">
      <div className="mx-auto max-w-2xl px-4 py-8">
        {/* Page header */}
        <div className="mb-6">
          <h1 className="text-2xl font-bold tracking-tight">高鐵查詢</h1>
          <p className="text-muted-foreground text-sm mt-1">查詢班次時刻與座位狀態</p>
        </div>

        {/* Top-level mode switcher */}
        <Tabs defaultValue="by-od" className="w-full">
          <TabsList className="w-full grid grid-cols-3 mb-4">
            <TabsTrigger value="by-od">時間查詢</TabsTrigger>
            <TabsTrigger value="by-train">車次查詢</TabsTrigger>
            <TabsTrigger value="by-station">車站查詢</TabsTrigger>
          </TabsList>

          {/* Tab 1: By OD (Phase 2 — unchanged behavior) */}
          <TabsContent value="by-od">
            <div className="mb-6 rounded-lg border bg-card p-4 shadow-sm">
              <QueryForm onSubmit={setQueryParams} />
            </div>
            <TrainList params={queryParams} />
          </TabsContent>

          {/* Tab 2: By Train Number (Plan 01) */}
          <TabsContent value="by-train">
            <div className="mb-2 rounded-lg border bg-card p-4 shadow-sm">
              <ByTrainForm onSubmit={setTrainNo} />
            </div>
            <ByTrainResult trainNo={trainNo} />
          </TabsContent>

          {/* Tab 3: By Station (Plan 02) */}
          <TabsContent value="by-station">
            <div className="mb-2 rounded-lg border bg-card p-4 shadow-sm">
              <ByStationForm onSubmit={setStationId} />
            </div>
            <ByStationResult stationId={stationId} />
          </TabsContent>
        </Tabs>
      </div>
    </main>
  )
}
```
  </action>
  <verify>
1. Run `npx tsc --noEmit` — 0 errors.
2. Run `npm run build` — exits 0 with no errors.
3. Run `npm run dev` and open http://localhost:3000 — verify:
   a. Three tabs visible at top: 時間查詢 | 車次查詢 | 車站查詢
   b. 時間查詢 tab is active by default; QueryForm renders correctly
   c. Switch to 車次查詢 tab; input field appears with placeholder "例：0117"
   d. Type "0101" and submit; stop list renders with 12 stations
   e. Switch to 車站查詢 tab; station select appears
   f. Select a station and submit; 北上/南下 tabs appear with train rows and SeatBadge
  </verify>
  <done>
`npm run build` exits 0. All three tabs are visible and functional end-to-end in the browser. Phase 2 time-query behavior is unchanged. By-train shows stop timeline. By-station shows northbound/southbound seat status with SeatBadge.
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes (0 errors across entire project)
- `npm run build` succeeds
- http://localhost:3000 shows three-tab layout (時間查詢 | 車次查詢 | 車站查詢)
- 時間查詢 tab: Phase 2 QueryForm + TrainList works identically to Phase 2 verification
- 車次查詢 tab: Input "0101" → 12-stop table renders; "9999" → "查無車次" message
- 車站查詢 tab: Select 台北 → 北上/南下 tabs with train rows and SeatBadge; empty arrays handled gracefully
- `/api/tdx/seat-status?stationId=2` → `{"northbound":[...],"southbound":[...]}`
- `/api/tdx/seat-status` (no param) → 400 error JSON
- Direction split verified: northbound trains have Direction===1, southbound have Direction===0
</verification>

<success_criteria>
- GET /api/tdx/seat-status route exists with force-dynamic, mock short-circuit, and Direction split (0=南下, 1=北上)
- ByStationForm: station select reuses ['stations'] React Query cache; submit emits stationId
- ByStationResult: Tabs with defaultValue="northbound"; TrainSeatRow matches StationID to find correct leg's seat status; idle=null, loading=skeletons, error=red message, empty direction="目前無…班次資料"
- page.tsx: top-level Tabs with three TabsContent; Phase 2 QueryForm+TrainList intact inside by-od; ByTrainForm+ByTrainResult inside by-train; ByStationForm+ByStationResult inside by-station
- Phase 3 QURY-03 requirement fully satisfied: by-train stop timeline queryable by train number
- Phase 3 success criteria 1, 2, 3 all met (both query modes work with all three UI states)
</success_criteria>

<output>
After completion, create `.planning/phases/03-secondary-queries/03-02-SUMMARY.md` using the template at @/Users/diamond.hung/.claude/get-shit-done/templates/summary.md
</output>
