---
phase: 03-secondary-queries
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/types/tdx.ts
  - src/fixtures/tdx-mock.ts
  - src/lib/tdx-api.ts
  - src/app/api/tdx/timetable-by-train/route.ts
  - src/components/by-train-form.tsx
  - src/components/by-train-result.tsx
autonomous: true
requirements:
  - QURY-03

must_haves:
  truths:
    - "使用者輸入車次號後，送出查詢可取得該列車的完整停站清單"
    - "停站清單顯示每站的到站時刻與離站時刻（起站無到站、末站無離站）"
    - "輸入無效車次號（非 1-4 位數字）時，查詢按鈕不可按"
    - "查詢中顯示 loading 骨架，查無資料顯示「查無車次資料」，API 錯誤顯示錯誤訊息"
  artifacts:
    - path: "src/types/tdx.ts"
      provides: "Phase 3 types: TdxGeneralTimetableStop, TdxGeneralTimetableResponse, TdxTrainStop, TdxStationSeatStatus"
      contains: "TdxGeneralTimetableStop"
    - path: "src/fixtures/tdx-mock.ts"
      provides: "MOCK_TIMETABLE_BY_TRAIN keyed by trainNo string"
      contains: "MOCK_TIMETABLE_BY_TRAIN"
    - path: "src/lib/tdx-api.ts"
      provides: "fetchGeneralTimetable(trainNo) calling TDX GeneralTimetable/TrainNo endpoint"
      exports: ["fetchGeneralTimetable"]
    - path: "src/app/api/tdx/timetable-by-train/route.ts"
      provides: "GET /api/tdx/timetable-by-train?trainNo= returns TdxTrainStop[]"
      contains: "export const dynamic = 'force-dynamic'"
    - path: "src/components/by-train-form.tsx"
      provides: "Train number input with digit validation and submit"
    - path: "src/components/by-train-result.tsx"
      provides: "Stop timeline rendering with loading/empty/error states"
  key_links:
    - from: "src/components/by-train-form.tsx"
      to: "src/components/by-train-result.tsx"
      via: "trainNo state passed as prop"
      pattern: "trainNo.*string"
    - from: "src/components/by-train-result.tsx"
      to: "/api/tdx/timetable-by-train"
      via: "useQuery fetch in React Query hook"
      pattern: "fetch.*timetable-by-train"
    - from: "src/app/api/tdx/timetable-by-train/route.ts"
      to: "src/lib/tdx-api.ts"
      via: "fetchGeneralTimetable(trainNo)"
      pattern: "fetchGeneralTimetable"
    - from: "src/lib/tdx-api.ts"
      to: "TDX_BASE/GeneralTimetable/TrainNo"
      via: "authenticated fetch"
      pattern: "GeneralTimetable/TrainNo"
---

<objective>
Build the by-train query feature end-to-end: types, mock data, tdx-api function, Route Handler, and two React components (form + result).

Purpose: QURY-03 — 使用者可輸入車次號查詢單一列車的完整停站與時刻表.
Output: Working `/api/tdx/timetable-by-train` Route Handler + `ByTrainForm` + `ByTrainResult` components, ready to embed in page.tsx in Plan 02.
</objective>

<execution_context>
@/Users/diamond.hung/.claude/get-shit-done/workflows/execute-plan.md
@/Users/diamond.hung/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-secondary-queries/03-RESEARCH.md
@src/types/tdx.ts
@src/fixtures/tdx-mock.ts
@src/lib/tdx-api.ts
@src/app/api/tdx/trains/route.ts
@src/components/seat-badge.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Types, mock data, and tdx-api extension</name>
  <files>
    src/types/tdx.ts
    src/fixtures/tdx-mock.ts
    src/lib/tdx-api.ts
  </files>
  <action>
**src/types/tdx.ts** — Append the following Phase 3 types after the existing Phase 2 block:

```typescript
// --- Phase 3: By-Train and By-Station types ---

/** One stop in GeneralTimetable/TrainNo response (raw TDX shape) */
export interface TdxGeneralTimetableStop {
  StopSequence: number
  StationID: string               // e.g. "1"
  StationName: TdxStationName     // Zh_tw, En
  ArrivalTime: string             // "HH:MM"; empty string "" for first stop (train origin)
  DepartureTime: string           // "HH:MM"; empty string "" for last stop (train terminus)
}

/** TDX GeneralTimetable/TrainNo/{TrainNo} response element (API returns an array) */
export interface TdxGeneralTimetableResponse {
  GeneralTimetable: {
    GeneralTrainInfo: {
      TrainNo: string
      Direction: 0 | 1
      StartingStationID: string
      EndingStationID: string
    }
    StopTimes: TdxGeneralTimetableStop[]
  }
}

/** Server-normalized stop returned from /api/tdx/timetable-by-train */
export interface TdxTrainStop {
  sequence: number
  stationId: string
  stationName: string             // Zh_tw only
  arrivalTime: string             // "HH:MM" or "" for first stop
  departureTime: string           // "HH:MM" or "" for last stop
}

/** Server response from /api/tdx/seat-status (pre-split by Direction) */
export interface TdxStationSeatStatus {
  northbound: TdxSeatStatus[]     // Direction === 1
  southbound: TdxSeatStatus[]     // Direction === 0
}
```

**src/fixtures/tdx-mock.ts** — Add import for new types, then append two new exports at the bottom:

```typescript
// Add to the import line at top:
import type { TdxStation, TdxEnrichedTrain, TdxTrainStop, TdxSeatStatus, TdxStationSeatStatus } from '@/types/tdx'

// Append at end of file:

/** Mock for /api/tdx/timetable-by-train — keyed by trainNo string.
 *  Train 0101 is southbound (南港→左營), full 12-stop sequence.
 *  Train 0102 is northbound (左營→南港), full 12-stop sequence.
 *  Unknown train numbers return [] (empty array, not an error).
 */
export const MOCK_TIMETABLE_BY_TRAIN: Record<string, TdxTrainStop[]> = {
  '0101': [
    { sequence: 1,  stationId: '1',  stationName: '南港', arrivalTime: '',      departureTime: '06:00' },
    { sequence: 2,  stationId: '2',  stationName: '台北', arrivalTime: '06:06', departureTime: '06:07' },
    { sequence: 3,  stationId: '3',  stationName: '板橋', arrivalTime: '06:13', departureTime: '06:14' },
    { sequence: 4,  stationId: '4',  stationName: '桃園', arrivalTime: '06:27', departureTime: '06:28' },
    { sequence: 5,  stationId: '5',  stationName: '新竹', arrivalTime: '06:43', departureTime: '06:44' },
    { sequence: 6,  stationId: '6',  stationName: '苗栗', arrivalTime: '06:58', departureTime: '06:59' },
    { sequence: 7,  stationId: '7',  stationName: '台中', arrivalTime: '07:09', departureTime: '07:10' },
    { sequence: 8,  stationId: '8',  stationName: '彰化', arrivalTime: '07:20', departureTime: '07:21' },
    { sequence: 9,  stationId: '9',  stationName: '雲林', arrivalTime: '07:32', departureTime: '07:33' },
    { sequence: 10, stationId: '10', stationName: '嘉義', arrivalTime: '07:43', departureTime: '07:44' },
    { sequence: 11, stationId: '11', stationName: '台南', arrivalTime: '07:53', departureTime: '07:54' },
    { sequence: 12, stationId: '12', stationName: '左營', arrivalTime: '07:57', departureTime: '' },
  ],
  '0102': [
    { sequence: 1,  stationId: '12', stationName: '左營', arrivalTime: '',      departureTime: '06:30' },
    { sequence: 2,  stationId: '11', stationName: '台南', arrivalTime: '06:34', departureTime: '06:35' },
    { sequence: 3,  stationId: '10', stationName: '嘉義', arrivalTime: '06:44', departureTime: '06:45' },
    { sequence: 4,  stationId: '9',  stationName: '雲林', arrivalTime: '06:55', departureTime: '06:56' },
    { sequence: 5,  stationId: '8',  stationName: '彰化', arrivalTime: '07:07', departureTime: '07:08' },
    { sequence: 6,  stationId: '7',  stationName: '台中', arrivalTime: '07:18', departureTime: '07:19' },
    { sequence: 7,  stationId: '6',  stationName: '苗栗', arrivalTime: '07:29', departureTime: '07:30' },
    { sequence: 8,  stationId: '5',  stationName: '新竹', arrivalTime: '07:44', departureTime: '07:45' },
    { sequence: 9,  stationId: '4',  stationName: '桃園', arrivalTime: '08:00', departureTime: '08:01' },
    { sequence: 10, stationId: '3',  stationName: '板橋', arrivalTime: '08:14', departureTime: '08:15' },
    { sequence: 11, stationId: '2',  stationName: '台北', arrivalTime: '08:21', departureTime: '08:22' },
    { sequence: 12, stationId: '1',  stationName: '南港', arrivalTime: '08:28', departureTime: '' },
  ],
  '0115': [
    { sequence: 1,  stationId: '1',  stationName: '南港', arrivalTime: '',      departureTime: '14:00' },
    { sequence: 2,  stationId: '2',  stationName: '台北', arrivalTime: '14:06', departureTime: '14:07' },
    { sequence: 3,  stationId: '3',  stationName: '板橋', arrivalTime: '14:13', departureTime: '14:14' },
    { sequence: 4,  stationId: '7',  stationName: '台中', arrivalTime: '14:49', departureTime: '14:50' },
    { sequence: 5,  stationId: '11', stationName: '台南', arrivalTime: '15:19', departureTime: '15:20' },
    { sequence: 6,  stationId: '12', stationName: '左營', arrivalTime: '15:46', departureTime: '' },
  ],
}

/** Mock for /api/tdx/seat-status — pre-split into northbound/southbound.
 *  Used when stationId is any value in mock mode.
 */
export const MOCK_SEAT_STATUS_BY_STATION: TdxStationSeatStatus = {
  northbound: [
    {
      TrainNo: '0102', Direction: 1, StartingStationID: '12', EndingStationID: '1',
      StopStations: [
        { StopSequence: 1, StationID: '2', StationName: { Zh_tw: '台北', En: 'Taipei' }, NextStationID: '1', StandardSeatStatus: 'O', BusinessSeatStatus: 'O' },
      ],
    },
    {
      TrainNo: '0104', Direction: 1, StartingStationID: '12', EndingStationID: '1',
      StopStations: [
        { StopSequence: 1, StationID: '2', StationName: { Zh_tw: '台北', En: 'Taipei' }, NextStationID: '1', StandardSeatStatus: 'L', BusinessSeatStatus: 'O' },
      ],
    },
  ],
  southbound: [
    {
      TrainNo: '0101', Direction: 0, StartingStationID: '1', EndingStationID: '12',
      StopStations: [
        { StopSequence: 1, StationID: '2', StationName: { Zh_tw: '台北', En: 'Taipei' }, NextStationID: '3', StandardSeatStatus: 'L', BusinessSeatStatus: 'O' },
      ],
    },
    {
      TrainNo: '0103', Direction: 0, StartingStationID: '1', EndingStationID: '12',
      StopStations: [
        { StopSequence: 1, StationID: '2', StationName: { Zh_tw: '台北', En: 'Taipei' }, NextStationID: '3', StandardSeatStatus: 'X', BusinessSeatStatus: 'L' },
      ],
    },
  ],
}
```

**src/lib/tdx-api.ts** — Append after the existing `fetchSeatStatus` function. Also add `TdxGeneralTimetableStop` and `TdxGeneralTimetableResponse` to the import line at the top:

```typescript
// Update import line to include new types:
import type { TdxStation, TdxDailyTrain, TdxSeatStatus, TdxGeneralTimetableStop, TdxGeneralTimetableResponse } from '@/types/tdx'

// Append new function at end of file:
/**
 * Fetch general timetable (all stops) for a single train by train number.
 * Mock mode: Not called directly — Route Handler returns MOCK_TIMETABLE_BY_TRAIN.
 * Real mode: GET /GeneralTimetable/TrainNo/{trainNo}
 * Response is an array — take [0] (one schedule per unique train number).
 * Returns empty array [] if train number not found (not a 5xx error).
 * IMPORTANT: ArrivalTime is "" for first stop; DepartureTime is "" for last stop — not errors.
 */
export async function fetchGeneralTimetable(trainNo: string): Promise<TdxGeneralTimetableStop[]> {
  const token = await getTdxToken()
  const res = await fetch(
    `${TDX_BASE}/GeneralTimetable/TrainNo/${trainNo}`,
    { headers: { Authorization: `Bearer ${token}` } }
    // No revalidate — route.ts sets force-dynamic
  )
  if (!res.ok) {
    throw new Error(`TDX GeneralTimetable failed: ${res.status} ${res.statusText}`)
  }
  const data: TdxGeneralTimetableResponse[] = await res.json()
  if (!data.length) return []
  // Response is array; take first element (one schedule per train number)
  return data[0].GeneralTimetable.StopTimes
}
```
  </action>
  <verify>
Run `npx tsc --noEmit` in /Users/diamond.hung/ailabs/code/thsr-query — must pass with 0 errors. Confirm `MOCK_TIMETABLE_BY_TRAIN` and `MOCK_SEAT_STATUS_BY_STATION` are exported, and `fetchGeneralTimetable` is exported from tdx-api.ts.
  </verify>
  <done>
`npx tsc --noEmit` exits 0. `grep -n "fetchGeneralTimetable\|MOCK_TIMETABLE_BY_TRAIN\|TdxTrainStop\|TdxStationSeatStatus" src/lib/tdx-api.ts src/fixtures/tdx-mock.ts src/types/tdx.ts` shows all four identifiers present in their respective files.
  </done>
</task>

<task type="auto">
  <name>Task 2: Route Handler and display components for by-train query</name>
  <files>
    src/app/api/tdx/timetable-by-train/route.ts
    src/components/by-train-form.tsx
    src/components/by-train-result.tsx
  </files>
  <action>
**Step 1 — Install shadcn components:**
Run: `npx shadcn@latest add tabs input` in /Users/diamond.hung/ailabs/code/thsr-query
This installs `src/components/ui/tabs.tsx` and `src/components/ui/input.tsx`. Accept all defaults.

**Step 2 — Create `src/app/api/tdx/timetable-by-train/route.ts`:**

```typescript
// GET /api/tdx/timetable-by-train?trainNo=<string>
// Returns TdxTrainStop[] — normalized stop array for the given train number.
// Empty array [] means train not found (not an error).
// Uses force-dynamic: GeneralTimetable is static but mock mode needs per-request behavior.

import { isMockMode, fetchGeneralTimetable } from '@/lib/tdx-api'
import { MOCK_TIMETABLE_BY_TRAIN } from '@/fixtures/tdx-mock'
import { NextResponse } from 'next/server'
import type { TdxGeneralTimetableStop, TdxTrainStop } from '@/types/tdx'

export const dynamic = 'force-dynamic'

export async function GET(request: Request) {
  const { searchParams } = new URL(request.url)
  const trainNo = searchParams.get('trainNo')

  if (!trainNo) {
    return NextResponse.json(
      { error: 'Missing required parameter: trainNo' },
      { status: 400 }
    )
  }

  if (isMockMode()) {
    // Return empty array for unknown train numbers (not an error)
    const result = MOCK_TIMETABLE_BY_TRAIN[trainNo] ?? []
    return NextResponse.json(result)
  }

  try {
    const rawStops: TdxGeneralTimetableStop[] = await fetchGeneralTimetable(trainNo)
    // Normalize from TDX raw shape to server-simplified TdxTrainStop
    const stops: TdxTrainStop[] = rawStops.map(stop => ({
      sequence: stop.StopSequence,
      stationId: stop.StationID,
      stationName: stop.StationName.Zh_tw,
      arrivalTime: stop.ArrivalTime,       // "" for first stop — pass through as-is
      departureTime: stop.DepartureTime,   // "" for last stop — pass through as-is
    }))
    return NextResponse.json(stops)
  } catch (error) {
    console.error('[/api/tdx/timetable-by-train] Error:', error)
    return NextResponse.json(
      { error: 'Failed to fetch timetable from TDX' },
      { status: 502 }
    )
  }
}
```

**Step 3 — Create `src/components/by-train-form.tsx`:**

```tsx
// src/components/by-train-form.tsx
// Train number input with digit-only validation (1-4 chars).
// Emits trainNo string to parent via onSubmit; does NOT fetch data itself.
'use client'

import { useState } from 'react'
import { Search } from 'lucide-react'
import { Button } from '@/components/ui/button'
import { Input } from '@/components/ui/input'
import { Label } from '@/components/ui/label'

interface ByTrainFormProps {
  onSubmit: (trainNo: string) => void
}

/** Validates train number: digits only, 1-4 characters. */
function isValidTrainNo(value: string): boolean {
  return /^\d{1,4}$/.test(value.trim())
}

export function ByTrainForm({ onSubmit }: ByTrainFormProps) {
  const [trainNo, setTrainNo] = useState('')

  function handleSubmit(e: React.FormEvent) {
    e.preventDefault()
    if (!isValidTrainNo(trainNo)) return
    onSubmit(trainNo.trim())
  }

  const isValid = isValidTrainNo(trainNo)

  return (
    <form onSubmit={handleSubmit} className="space-y-3">
      <div className="space-y-1.5">
        <Label htmlFor="train-no">車次號</Label>
        <Input
          id="train-no"
          type="text"
          inputMode="numeric"
          placeholder="例：0117"
          value={trainNo}
          onChange={e => setTrainNo(e.target.value)}
          maxLength={4}
          className="max-w-[160px]"
          autoComplete="off"
        />
        <p className="text-xs text-muted-foreground">請輸入 1–4 位數字車次號</p>
      </div>
      <Button type="submit" disabled={!isValid}>
        <Search className="mr-2 h-4 w-4" />
        查詢
      </Button>
    </form>
  )
}
```

**Step 4 — Create `src/components/by-train-result.tsx`:**

```tsx
// src/components/by-train-result.tsx
// Displays stop timeline for a queried train number.
// States: idle (no trainNo), loading, empty (train not found), error, result.
'use client'

import { useQuery } from '@tanstack/react-query'
import { Skeleton } from '@/components/ui/skeleton'
import type { TdxTrainStop } from '@/types/tdx'

interface ByTrainResultProps {
  trainNo: string | null   // null = idle (no query submitted yet)
}

async function fetchTrainStops(trainNo: string): Promise<TdxTrainStop[]> {
  const res = await fetch(`/api/tdx/timetable-by-train?trainNo=${encodeURIComponent(trainNo)}`)
  if (!res.ok) {
    const body = await res.json().catch(() => ({}))
    throw new Error(body.error ?? `HTTP ${res.status}`)
  }
  return res.json()
}

export function ByTrainResult({ trainNo }: ByTrainResultProps) {
  const { data: stops, isLoading, isError, error } = useQuery({
    queryKey: ['timetable-by-train', trainNo],
    queryFn: () => fetchTrainStops(trainNo!),
    enabled: !!trainNo,
    staleTime: 60 * 60 * 1000,   // 1h — GeneralTimetable is static schedule data
    retry: 1,
  })

  // Idle: no query submitted
  if (!trainNo) {
    return null
  }

  // Loading skeleton
  if (isLoading) {
    return (
      <div className="space-y-2 mt-4">
        {Array.from({ length: 6 }).map((_, i) => (
          <Skeleton key={i} className="h-10 w-full rounded-md" />
        ))}
      </div>
    )
  }

  // API error
  if (isError) {
    return (
      <div className="mt-4 rounded-md border border-destructive/30 bg-destructive/5 px-4 py-3 text-sm text-destructive">
        無法取得時刻表：{error instanceof Error ? error.message : '未知錯誤'}
      </div>
    )
  }

  // Empty — train number not found
  if (!stops || stops.length === 0) {
    return (
      <div className="mt-4 rounded-md border bg-muted/50 px-4 py-8 text-center text-sm text-muted-foreground">
        查無車次「{trainNo}」的資料，請確認車次號是否正確
      </div>
    )
  }

  // Result: stop timeline table
  return (
    <div className="mt-4 rounded-lg border bg-card shadow-sm overflow-hidden">
      <div className="px-4 py-3 border-b bg-muted/30">
        <p className="text-sm font-medium">車次 {trainNo} 停靠站</p>
        <p className="text-xs text-muted-foreground mt-0.5">{stops.length} 站</p>
      </div>
      <div className="divide-y">
        {stops.map((stop) => (
          <div key={stop.sequence} className="flex items-center gap-4 px-4 py-3">
            {/* Sequence number */}
            <span className="text-xs text-muted-foreground w-4 shrink-0 text-right">
              {stop.sequence}
            </span>
            {/* Station name */}
            <span className="flex-1 text-sm font-medium">{stop.stationName}</span>
            {/* Times: arrival | departure */}
            <div className="flex gap-3 text-sm tabular-nums text-right">
              <span className="text-muted-foreground w-12">
                {/* First stop has no arrival time */}
                {stop.arrivalTime || '—'}
              </span>
              <span className="w-12">
                {/* Last stop has no departure time */}
                {stop.departureTime || '—'}
              </span>
            </div>
          </div>
        ))}
      </div>
      {/* Column headers (sticky top inside scroll if needed) */}
      <div className="flex items-center gap-4 px-4 py-2 border-t bg-muted/20 text-xs text-muted-foreground">
        <span className="w-4 shrink-0" />
        <span className="flex-1">車站</span>
        <div className="flex gap-3 text-right">
          <span className="w-12">到站</span>
          <span className="w-12">離站</span>
        </div>
      </div>
    </div>
  )
}
```
  </action>
  <verify>
1. Run `npx tsc --noEmit` — 0 errors.
2. Run `npm run build` — builds successfully.
3. Run `npm run dev` and `curl "http://localhost:3000/api/tdx/timetable-by-train?trainNo=0101"` — returns JSON array of 12 stops with sequence/stationName/arrivalTime/departureTime fields.
4. `curl "http://localhost:3000/api/tdx/timetable-by-train?trainNo=9999"` — returns `[]` (empty array, not an error).
5. `curl "http://localhost:3000/api/tdx/timetable-by-train"` — returns `{"error":"Missing required parameter: trainNo"}` with status 400.
  </verify>
  <done>
All 5 curl checks pass as described. TypeScript compiles with 0 errors. `ByTrainForm` and `ByTrainResult` components exist and import correctly. The `by-train-form.tsx` disables the submit button for non-digit or empty input.
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes (0 errors)
- `npm run build` succeeds
- `/api/tdx/timetable-by-train?trainNo=0101` returns 12-stop JSON array
- `/api/tdx/timetable-by-train?trainNo=9999` returns `[]`
- `/api/tdx/timetable-by-train` (no param) returns 400 error JSON
- All new files exist: route.ts, by-train-form.tsx, by-train-result.tsx, ui/tabs.tsx, ui/input.tsx
- No TypeScript errors in new or modified files
</verification>

<success_criteria>
- TdxTrainStop, TdxStationSeatStatus, TdxGeneralTimetableStop, TdxGeneralTimetableResponse types defined in src/types/tdx.ts
- MOCK_TIMETABLE_BY_TRAIN (3 train numbers) and MOCK_SEAT_STATUS_BY_STATION defined in src/fixtures/tdx-mock.ts
- fetchGeneralTimetable(trainNo) added to src/lib/tdx-api.ts, taking data[0].GeneralTimetable.StopTimes with empty-array guard
- GET /api/tdx/timetable-by-train route exists with force-dynamic, mock short-circuit, and normalization from raw TDX to TdxTrainStop
- ByTrainForm: Input validates /^\d{1,4}$/, submit disabled when invalid
- ByTrainResult: idle=null, loading=skeletons, error=red message, empty="查無車次", result=stop table with "—" for empty arrival/departure
</success_criteria>

<output>
After completion, create `.planning/phases/03-secondary-queries/03-01-SUMMARY.md` using the template at @/Users/diamond.hung/.claude/get-shit-done/templates/summary.md
</output>
