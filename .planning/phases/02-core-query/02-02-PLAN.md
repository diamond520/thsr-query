---
phase: 02-core-query
plan: "02"
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/lib/taiwan-date.ts
  - src/components/seat-badge.tsx
  - src/components/query-form.tsx
autonomous: true
requirements: [UIUX-03, UIUX-04, QURY-01]

must_haves:
  truths:
    - "QueryForm renders origin select, destination select, date picker (defaulting to Taiwan today), swap button, and submit button"
    - "Clicking the swap button exchanges origin and destination values without reloading"
    - "The date default is Taiwan timezone (UTC+8) — no hydration mismatch error in console"
    - "SeatBadge renders a green badge for 'O' (充足), yellow/amber for 'L' (有限), red for 'X' (售完), gray dash for null"
    - "商務席 label text renders in amber/gold color, visually distinct from 標準席 gray"
    - "QueryForm is usable on mobile (full-width selects, large tap targets) — layout: [origin][swap][dest] on one row, date below, submit below"
  artifacts:
    - path: "src/lib/taiwan-date.ts"
      provides: "getTaiwanToday() returning Date object in Asia/Taipei timezone"
      exports: ["getTaiwanToday"]
    - path: "src/components/seat-badge.tsx"
      provides: "SeatBadge component mapping TdxSeatCode to Chinese label + color badge"
      exports: ["SeatBadge"]
    - path: "src/components/query-form.tsx"
      provides: "QueryForm component — controlled form with station selects, date picker, swap button"
      exports: ["QueryForm", "QueryParams"]
  key_links:
    - from: "src/components/query-form.tsx"
      to: "src/lib/taiwan-date.ts"
      via: "useState(() => getTaiwanToday()) for hydration-safe date init"
      pattern: "getTaiwanToday"
    - from: "src/components/query-form.tsx"
      to: "parent component (page.tsx in Plan 02-04)"
      via: "onSubmit(params: QueryParams) callback prop"
      pattern: "onSubmit.*QueryParams"
    - from: "src/components/seat-badge.tsx"
      to: "src/types/tdx.ts"
      via: "import type TdxSeatCode — typed status prop"
      pattern: "import.*TdxSeatCode"
---

<objective>
Build the query form UI and the seat badge component. This plan installs all required shadcn components, creates the Taiwan timezone utility, implements the SeatBadge with correct color mapping, and implements the QueryForm with station selects, date picker, swap button, and form submit callback.

Purpose: The query form is the user's entry point. It must handle the Taiwan timezone default correctly (UIUX-03) and provide a swap button for quick origin/destination reversal (UIUX-04). SeatBadge is a shared atom used by both mobile card and desktop table (Plan 02-03).

Output: `src/lib/taiwan-date.ts`, `src/components/seat-badge.tsx`, `src/components/query-form.tsx`; all shadcn UI components installed.
</objective>

<execution_context>
@/Users/diamond.hung/.claude/get-shit-done/workflows/execute-plan.md
@/Users/diamond.hung/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/types/tdx.ts
@src/fixtures/tdx-mock.ts
@.planning/phases/02-core-query/02-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install shadcn components, taiwan-date utility, and SeatBadge component</name>
  <files>src/lib/taiwan-date.ts, src/components/seat-badge.tsx</files>
  <action>
**Step 1: Install shadcn components** (run from project root `/Users/diamond.hung/ailabs/code/thsr-query`):

```bash
npx shadcn@latest add select badge skeleton card calendar popover --yes
npm install date-fns
```

These commands copy component source into `src/components/ui/`. If prompted for overwrite, accept. The `--yes` flag auto-accepts. If `--yes` is not recognized by this shadcn version, run without it and accept prompts.

**Step 2: Create `src/lib/taiwan-date.ts`**:

```typescript
// src/lib/taiwan-date.ts
// Taiwan timezone utility — safe in both server and client environments.
// Taiwan (Asia/Taipei) is always UTC+8, never observes DST.

/**
 * Returns today's date as a Date object using Asia/Taipei timezone.
 * Use inside useState() initializer to avoid server/client hydration mismatch:
 *   const [date, setDate] = useState<Date>(() => getTaiwanToday())
 *
 * DO NOT call outside useState/useEffect on client — server renders UTC,
 * client initializer runs in browser timezone-aware context.
 */
export function getTaiwanToday(): Date {
  // en-CA locale produces "YYYY-MM-DD" format directly
  const dateStr = new Intl.DateTimeFormat('en-CA', {
    timeZone: 'Asia/Taipei',
    year: 'numeric',
    month: '2-digit',
    day: '2-digit',
  }).format(new Date())
  // Append T00:00:00 to parse as midnight local time (not UTC midnight)
  return new Date(dateStr + 'T00:00:00')
}
```

**Step 3: Create `src/components/seat-badge.tsx`**:

```typescript
// src/components/seat-badge.tsx
// Per user decision (LOCKED):
// - Colors: 充足=green, 有限=amber/yellow, 售完=red
// - 商務席 label uses amber color to distinguish from 標準席
// - Badge text is full Chinese: 充足 / 有限 / 售完
// - null status shows "—" (gray) — train not in seat status list

import { Badge } from '@/components/ui/badge'
import { cn } from '@/lib/utils'
import type { TdxSeatCode } from '@/types/tdx'

const STATUS_CONFIG: Record<TdxSeatCode, { label: string; className: string }> = {
  O: { label: '充足', className: 'bg-green-100 text-green-800 border-green-300 hover:bg-green-100' },
  L: { label: '有限', className: 'bg-amber-100 text-amber-800 border-amber-300 hover:bg-amber-100' },
  X: { label: '售完', className: 'bg-red-100 text-red-800 border-red-300 hover:bg-red-100' },
}

interface SeatBadgeProps {
  status: TdxSeatCode | null
  type: '標準席' | '商務席'
  className?: string
}

export function SeatBadge({ status, type, className }: SeatBadgeProps) {
  const config = status ? STATUS_CONFIG[status] : null

  return (
    <div className={cn('flex items-center gap-1.5', className)}>
      {/* 商務席 label is amber/gold to distinguish from 標準席 (per user decision) */}
      <span
        className={cn(
          'text-xs font-medium shrink-0',
          type === '商務席' ? 'text-amber-700' : 'text-muted-foreground'
        )}
      >
        {type}
      </span>
      {config ? (
        <Badge
          variant="outline"
          className={cn('text-xs px-1.5 py-0 h-5 font-normal', config.className)}
        >
          {config.label}
        </Badge>
      ) : (
        <Badge
          variant="outline"
          className="text-xs px-1.5 py-0 h-5 font-normal text-muted-foreground border-border"
        >
          —
        </Badge>
      )}
    </div>
  )
}
```
  </action>
  <verify>
1. `ls src/components/ui/select.tsx src/components/ui/badge.tsx src/components/ui/skeleton.tsx src/components/ui/card.tsx src/components/ui/calendar.tsx src/components/ui/popover.tsx` — all 6 files exist
2. `ls src/lib/taiwan-date.ts` — file exists
3. `ls src/components/seat-badge.tsx` — file exists
4. `npx tsc --noEmit` — 0 errors
5. `grep "getTaiwanToday" src/lib/taiwan-date.ts` — function found
6. `grep "STATUS_CONFIG" src/components/seat-badge.tsx` — config object found with O, L, X keys
  </verify>
  <done>
    - All 6 shadcn UI components installed in `src/components/ui/`
    - `date-fns` in `node_modules` (installed)
    - `src/lib/taiwan-date.ts` exports `getTaiwanToday(): Date` using `Intl.DateTimeFormat` with `Asia/Taipei`
    - `src/components/seat-badge.tsx` exports `SeatBadge` with green/amber/red color mapping and amber 商務席 label
    - TypeScript 0 errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Create QueryForm component</name>
  <files>src/components/query-form.tsx</files>
  <action>
Create `src/components/query-form.tsx`. This is a 'use client' component.

**Layout (LOCKED — per user decisions):**
- Mobile: `[起站 select][⇄ swap button][訖站 select]` on one row / `[日期 picker]` below / `[查詢按鈕]` below
- Stations loaded via React Query from `/api/tdx/stations` (already built in Phase 1)
- Date defaults to Taiwan today (call `getTaiwanToday()` inside `useState` initializer)
- Swap button uses `ArrowLeftRight` icon from lucide-react (circle-arrow style)
- On submit: calls `onSubmit(params: QueryParams)` prop — does NOT navigate

**Deferred (OUT OF SCOPE):** round-trip queries, memorizing last query.

```typescript
// src/components/query-form.tsx
'use client'

import { useState } from 'react'
import { useQuery } from '@tanstack/react-query'
import { format } from 'date-fns'
import { ArrowLeftRight, CalendarIcon, Search } from 'lucide-react'
import { Button } from '@/components/ui/button'
import { Calendar } from '@/components/ui/calendar'
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select'
import {
  Popover,
  PopoverContent,
  PopoverTrigger,
} from '@/components/ui/popover'
import { cn } from '@/lib/utils'
import { getTaiwanToday } from '@/lib/taiwan-date'
import type { TdxStation } from '@/types/tdx'

export interface QueryParams {
  origin: string       // TDX StationID e.g. "1"
  destination: string  // TDX StationID e.g. "12"
  date: string         // YYYY-MM-DD format for API call
}

interface QueryFormProps {
  onSubmit: (params: QueryParams) => void
}

async function fetchStations(): Promise<TdxStation[]> {
  const res = await fetch('/api/tdx/stations')
  if (!res.ok) throw new Error('Failed to load stations')
  return res.json()
}

export function QueryForm({ onSubmit }: QueryFormProps) {
  const [origin, setOrigin] = useState<string>('')
  const [destination, setDestination] = useState<string>('')
  // getTaiwanToday() called inside useState initializer — avoids hydration mismatch
  const [date, setDate] = useState<Date>(() => getTaiwanToday())
  const [calendarOpen, setCalendarOpen] = useState(false)

  const { data: stations = [], isLoading: stationsLoading } = useQuery({
    queryKey: ['stations'],
    queryFn: fetchStations,
    staleTime: 24 * 60 * 60 * 1000,  // 24h — stations rarely change
  })

  function handleSwap() {
    setOrigin(destination)
    setDestination(origin)
  }

  function handleSubmit(e: React.FormEvent) {
    e.preventDefault()
    if (!origin || !destination || !date) return
    if (origin === destination) return  // Same station — no-op

    // format() from date-fns produces "YYYY-MM-DD" in local time
    onSubmit({
      origin,
      destination,
      date: format(date, 'yyyy-MM-dd'),
    })
  }

  const isValid = !!origin && !!destination && !!date && origin !== destination

  return (
    <form onSubmit={handleSubmit} className="space-y-3">
      {/* Row 1: Origin [Swap] Destination — side by side on all screen sizes */}
      <div className="flex items-center gap-2">
        {/* Origin station select */}
        <Select value={origin} onValueChange={setOrigin} disabled={stationsLoading}>
          <SelectTrigger className="flex-1 min-w-0">
            <SelectValue placeholder="起站" />
          </SelectTrigger>
          <SelectContent>
            {stations.map(station => (
              <SelectItem key={station.StationID} value={station.StationID}>
                {station.StationName.Zh_tw}
              </SelectItem>
            ))}
          </SelectContent>
        </Select>

        {/* Swap button — per user decision: circle-arrow icon, between the two selects */}
        <Button
          type="button"
          variant="outline"
          size="icon"
          onClick={handleSwap}
          disabled={!origin && !destination}
          aria-label="交換起訖站"
          className="shrink-0"
        >
          <ArrowLeftRight className="h-4 w-4" />
        </Button>

        {/* Destination station select */}
        <Select value={destination} onValueChange={setDestination} disabled={stationsLoading}>
          <SelectTrigger className="flex-1 min-w-0">
            <SelectValue placeholder="訖站" />
          </SelectTrigger>
          <SelectContent>
            {stations.map(station => (
              <SelectItem key={station.StationID} value={station.StationID}>
                {station.StationName.Zh_tw}
              </SelectItem>
            ))}
          </SelectContent>
        </Select>
      </div>

      {/* Row 2: Date picker */}
      <Popover open={calendarOpen} onOpenChange={setCalendarOpen}>
        <PopoverTrigger asChild>
          <Button
            variant="outline"
            className={cn(
              'w-full justify-start text-left font-normal',
              !date && 'text-muted-foreground'
            )}
          >
            <CalendarIcon className="mr-2 h-4 w-4" />
            {date ? format(date, 'yyyy-MM-dd') : '選擇日期'}
          </Button>
        </PopoverTrigger>
        <PopoverContent className="w-auto p-0" align="start">
          <Calendar
            mode="single"
            selected={date}
            onSelect={(d) => {
              if (d) {
                setDate(d)
                setCalendarOpen(false)
              }
            }}
            defaultMonth={date}
            initialFocus
          />
        </PopoverContent>
      </Popover>

      {/* Row 3: Submit button */}
      <Button type="submit" className="w-full" disabled={!isValid}>
        <Search className="mr-2 h-4 w-4" />
        查詢
      </Button>
    </form>
  )
}
```

Note on `Button` component: shadcn does not install `button` via `shadcn add button` in this step because it should already be installed from the Phase 1 scaffold (create-next-app + shadcn init typically includes it). If `src/components/ui/button.tsx` does not exist, run `npx shadcn@latest add button` before writing this file.
  </action>
  <verify>
1. `npx tsc --noEmit` — 0 errors
2. `grep "QueryParams" src/components/query-form.tsx` — interface and export found
3. `grep "getTaiwanToday" src/components/query-form.tsx` — called inside useState initializer
4. `grep "ArrowLeftRight" src/components/query-form.tsx` — swap button uses this icon
5. `grep "handleSwap" src/components/query-form.tsx` — swap function swaps origin and destination state
6. `npm run build` — must succeed with 0 TypeScript errors (may show route warnings, that's OK)
  </verify>
  <done>
    - `src/components/query-form.tsx` exports `QueryForm` component and `QueryParams` interface
    - QueryForm has: origin select, destination select, ArrowLeftRight swap button, Calendar date picker (with Taiwan timezone default), search submit button
    - Date initialized via `useState(() => getTaiwanToday())` — hydration-safe
    - Swap button exchanges origin/destination in state
    - `onSubmit` prop receives `QueryParams` with YYYY-MM-DD date string
    - TypeScript 0 errors
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes with 0 errors
- All 6 shadcn components exist in `src/components/ui/`
- `src/lib/taiwan-date.ts` — `getTaiwanToday()` uses `Intl.DateTimeFormat` with `Asia/Taipei`
- `src/components/seat-badge.tsx` — STATUS_CONFIG maps O→green, L→amber, X→red; 商務席 label in amber
- `src/components/query-form.tsx` — exports `QueryForm` and `QueryParams`; swap handler swaps state; date defaults to getTaiwanToday() in useState initializer
- `npm run build` succeeds
</verification>

<success_criteria>
- shadcn components installed: select, badge, skeleton, card, calendar, popover
- `getTaiwanToday()` correctly returns Asia/Taipei date (not UTC)
- `SeatBadge` renders correct Chinese labels + colors for all status codes
- `QueryForm` renders correct mobile layout with swap functionality
- No TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-query/02-02-SUMMARY.md`
</output>
