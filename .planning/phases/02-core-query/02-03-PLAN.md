---
phase: 02-core-query
plan: "03"
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/components/train-card.tsx
  - src/components/train-table.tsx
  - src/components/train-list.tsx
autonomous: true
requirements: [QURY-02, QURY-04, UIUX-02]

must_haves:
  truths:
    - "TrainList shows a hint message when no query has been submitted (initial state)"
    - "TrainList shows 5 Skeleton cards while loading"
    - "TrainList shows a '無符合的班次' message when the API returns an empty array"
    - "TrainList shows an error message with a 重試 button when the API call fails"
    - "On mobile (< md breakpoint), each train is a Card with trainNo, departure, arrival, duration, StandardSeat badge, BusinessSeat badge, and a 去訂票 link"
    - "On desktop (>= md breakpoint), trains display as a table with columns: 車次, 出發, 抵達, 行車時間, 標準席, 商務席, 訂票"
    - "Clicking 去訂票 opens a new tab to https://www.thsrc.com.tw/TimeTable/Search via form POST with StartStation, EndStation, OutWardSearchDate, OutWardSearchTime pre-filled"
  artifacts:
    - path: "src/components/train-card.tsx"
      provides: "Mobile card for single train — uses SeatBadge, booking link"
      exports: ["TrainCard"]
    - path: "src/components/train-table.tsx"
      provides: "Desktop table for all trains — uses SeatBadge, booking link per row"
      exports: ["TrainTable"]
    - path: "src/components/train-list.tsx"
      provides: "Orchestrates all result states (idle/loading/error/empty/results) via React Query"
      exports: ["TrainList"]
  key_links:
    - from: "src/components/train-list.tsx"
      to: "/api/tdx/trains"
      via: "useQuery with enabled: !!params"
      pattern: "enabled.*params"
    - from: "src/components/train-card.tsx"
      to: "src/components/seat-badge.tsx"
      via: "import SeatBadge — renders StandardSeat and BusinessSeat rows"
      pattern: "import.*SeatBadge"
    - from: "train-card.tsx + train-table.tsx booking link"
      to: "https://www.thsrc.com.tw/TimeTable/Search"
      via: "form method=POST with hidden inputs, target=_blank"
      pattern: "thsrc\\.com\\.tw/TimeTable/Search"
---

<objective>
Build the result display UI: `TrainCard` (mobile), `TrainTable` (desktop), and `TrainList` (orchestrator that handles all 4 states: idle / loading / error / results). `TrainList` uses React Query `enabled: !!params` pattern to fire only after form submission.

Purpose: This is the core value delivery — the user sees train schedules and seat availability without any extra clicks. The booking link (去訂票) closes the loop: user can immediately proceed to purchase. Mobile card + desktop table satisfies UIUX-02 responsive requirement.

Output: `src/components/train-card.tsx`, `src/components/train-table.tsx`, `src/components/train-list.tsx`
</objective>

<execution_context>
@/Users/diamond.hung/.claude/get-shit-done/workflows/execute-plan.md
@/Users/diamond.hung/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/types/tdx.ts
@.planning/phases/02-core-query/02-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TrainCard and TrainTable components</name>
  <files>src/components/train-card.tsx, src/components/train-table.tsx</files>
  <action>
**Booking Link Implementation (applies to both components):**

THSR booking uses POST form — deep-link by trainNo is impossible (Wicket session-stateful system). The correct approach: a `<form method="POST" action="https://www.thsrc.com.tw/TimeTable/Search" target="_blank">` with hidden inputs. This pre-fills origin/destination/date/time, opening the THSR timetable search with the correct route selected. The user then clicks their train to book.

Station ID → THSR booking code mapping:
```
"1"→"NanGang", "2"→"Taipei", "3"→"Banqiao", "4"→"Taoyuan",
"5"→"Hsinchu", "6"→"Miaoli", "7"→"Taichung", "8"→"Changhua",
"9"→"Yunlin", "10"→"Chiayi", "11"→"Tainan", "12"→"ZuoYing"
```

Travel time calculation: `departureTime` and `arrivalTime` are "HH:MM" strings. Parse hours/minutes, subtract to get duration in minutes, format as "N時間M分".

---

**Create `src/components/train-card.tsx`** (mobile card, hidden on `md:` and above):

```typescript
// src/components/train-card.tsx
// Mobile-only card (hidden md:block). Per UIUX-02: large touch areas, card style.
'use client'

import { Card, CardContent } from '@/components/ui/card'
import { SeatBadge } from '@/components/seat-badge'
import type { TdxEnrichedTrain } from '@/types/tdx'

// Booking station code map — StationID (numeric string) → THSR POST form code
const BOOKING_CODE: Record<string, string> = {
  '1': 'NanGang', '2': 'Taipei', '3': 'Banqiao', '4': 'Taoyuan',
  '5': 'Hsinchu', '6': 'Miaoli', '7': 'Taichung', '8': 'Changhua',
  '9': 'Yunlin', '10': 'Chiayi', '11': 'Tainan', '12': 'ZuoYing',
}

function calcDuration(dep: string, arr: string): string {
  const [dh, dm] = dep.split(':').map(Number)
  const [ah, am] = arr.split(':').map(Number)
  const totalMin = (ah * 60 + am) - (dh * 60 + dm)
  const h = Math.floor(totalMin / 60)
  const m = totalMin % 60
  return h > 0 ? `${h}時${m}分` : `${m}分`
}

interface TrainCardProps {
  train: TdxEnrichedTrain
  origin: string       // StationID e.g. "1"
  destination: string  // StationID e.g. "12"
  date: string         // YYYY-MM-DD
}

export function TrainCard({ train, origin, destination, date }: TrainCardProps) {
  const duration = calcDuration(train.departureTime, train.arrivalTime)
  const startCode = BOOKING_CODE[origin] ?? origin
  const endCode = BOOKING_CODE[destination] ?? destination

  return (
    <Card className="w-full">
      <CardContent className="p-4">
        <div className="flex items-start justify-between gap-3">
          {/* Left: train number + time info */}
          <div className="flex-1 min-w-0">
            <div className="flex items-baseline gap-2 mb-2">
              <span className="text-lg font-semibold tabular-nums">{train.trainNo}</span>
              <span className="text-sm text-muted-foreground">{duration}</span>
            </div>
            <div className="flex items-center gap-2 text-base">
              <span className="font-medium tabular-nums">{train.departureTime}</span>
              <span className="text-muted-foreground text-xs">→</span>
              <span className="font-medium tabular-nums">{train.arrivalTime}</span>
            </div>
          </div>

          {/* Right: seat badges (per user decision: Standard + Business on two separate lines) */}
          <div className="flex flex-col gap-1 shrink-0">
            <SeatBadge status={train.standardSeat} type="標準席" />
            <SeatBadge status={train.businessSeat} type="商務席" />
          </div>
        </div>

        {/* Booking link — form POST to THSR timetable search */}
        <form
          method="POST"
          action="https://www.thsrc.com.tw/TimeTable/Search"
          target="_blank"
          rel="noopener noreferrer"
          className="mt-3"
        >
          <input type="hidden" name="SearchType" value="S" />
          <input type="hidden" name="StartStation" value={startCode} />
          <input type="hidden" name="EndStation" value={endCode} />
          <input type="hidden" name="OutWardSearchDate" value={date} />
          <input type="hidden" name="OutWardSearchTime" value={train.departureTime} />
          <button
            type="submit"
            className="w-full text-sm text-primary underline underline-offset-2 hover:text-primary/80 transition-colors text-left"
          >
            去訂票 →
          </button>
        </form>
      </CardContent>
    </Card>
  )
}
```

---

**Create `src/components/train-table.tsx`** (desktop table, hidden below `md:`):

```typescript
// src/components/train-table.tsx
// Desktop table (hidden md:hidden). Per UIUX-02: clean table style.
'use client'

import { SeatBadge } from '@/components/seat-badge'
import type { TdxEnrichedTrain } from '@/types/tdx'

const BOOKING_CODE: Record<string, string> = {
  '1': 'NanGang', '2': 'Taipei', '3': 'Banqiao', '4': 'Taoyuan',
  '5': 'Hsinchu', '6': 'Miaoli', '7': 'Taichung', '8': 'Changhua',
  '9': 'Yunlin', '10': 'Chiayi', '11': 'Tainan', '12': 'ZuoYing',
}

function calcDuration(dep: string, arr: string): string {
  const [dh, dm] = dep.split(':').map(Number)
  const [ah, am] = arr.split(':').map(Number)
  const totalMin = (ah * 60 + am) - (dh * 60 + dm)
  const h = Math.floor(totalMin / 60)
  const m = totalMin % 60
  return h > 0 ? `${h}時${m}分` : `${m}分`
}

interface TrainTableProps {
  trains: TdxEnrichedTrain[]
  origin: string
  destination: string
  date: string
}

export function TrainTable({ trains, origin, destination, date }: TrainTableProps) {
  const startCode = BOOKING_CODE[origin] ?? origin
  const endCode = BOOKING_CODE[destination] ?? destination

  return (
    <div className="w-full overflow-x-auto rounded-md border">
      <table className="w-full text-sm">
        <thead>
          <tr className="border-b bg-muted/50 text-muted-foreground">
            <th className="px-4 py-3 text-left font-medium">車次</th>
            <th className="px-4 py-3 text-left font-medium">出發</th>
            <th className="px-4 py-3 text-left font-medium">抵達</th>
            <th className="px-4 py-3 text-left font-medium">行車時間</th>
            <th className="px-4 py-3 text-left font-medium">標準席</th>
            <th className="px-4 py-3 text-left font-medium">商務席</th>
            <th className="px-4 py-3 text-left font-medium">訂票</th>
          </tr>
        </thead>
        <tbody>
          {trains.map(train => (
            <tr key={train.trainNo} className="border-b last:border-0 hover:bg-muted/30 transition-colors">
              <td className="px-4 py-3 font-semibold tabular-nums">{train.trainNo}</td>
              <td className="px-4 py-3 tabular-nums">{train.departureTime}</td>
              <td className="px-4 py-3 tabular-nums">{train.arrivalTime}</td>
              <td className="px-4 py-3 text-muted-foreground">
                {calcDuration(train.departureTime, train.arrivalTime)}
              </td>
              <td className="px-4 py-3">
                <SeatBadge status={train.standardSeat} type="標準席" />
              </td>
              <td className="px-4 py-3">
                <SeatBadge status={train.businessSeat} type="商務席" />
              </td>
              <td className="px-4 py-3">
                <form
                  method="POST"
                  action="https://www.thsrc.com.tw/TimeTable/Search"
                  target="_blank"
                  rel="noopener noreferrer"
                >
                  <input type="hidden" name="SearchType" value="S" />
                  <input type="hidden" name="StartStation" value={startCode} />
                  <input type="hidden" name="EndStation" value={endCode} />
                  <input type="hidden" name="OutWardSearchDate" value={date} />
                  <input type="hidden" name="OutWardSearchTime" value={train.departureTime} />
                  <button
                    type="submit"
                    className="text-primary underline underline-offset-2 hover:text-primary/80 transition-colors whitespace-nowrap text-sm"
                  >
                    去訂票
                  </button>
                </form>
              </td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>
  )
}
```
  </action>
  <verify>
1. `npx tsc --noEmit` — 0 errors
2. `grep "BOOKING_CODE" src/components/train-card.tsx src/components/train-table.tsx` — both files have the mapping
3. `grep "thsrc.com.tw/TimeTable/Search" src/components/train-card.tsx src/components/train-table.tsx` — booking form found in both
4. `grep "SeatBadge" src/components/train-card.tsx` — both 標準席 and 商務席 rendered
  </verify>
  <done>
    - `src/components/train-card.tsx` exports `TrainCard` — renders train number, times, duration, two SeatBadge rows, booking form POST
    - `src/components/train-table.tsx` exports `TrainTable` — renders table with 7 columns including two badge cells and booking form per row
    - Both use `BOOKING_CODE` mapping for StationID → THSR name code
    - Both open `thsrc.com.tw/TimeTable/Search` as form POST in `target="_blank"`
    - TypeScript 0 errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Create TrainList component with all state handling</name>
  <files>src/components/train-list.tsx</files>
  <action>
Create `src/components/train-list.tsx`. This is the central result orchestrator.

**State machine (per user decision — LOCKED):**
- `params === null` → idle: show hint text "選擇起訖站與日期，即可查詢時刻表"
- `isLoading` → show 5 Skeleton cards
- `isError` → show error text + 重試 button (calls `refetch()`)
- `data.length === 0` → show "無符合的班次"
- `data.length > 0` → show `TrainCard` list (mobile) + `TrainTable` (desktop) with `md:hidden` / `hidden md:block`

**CRITICAL React Query v5 pattern:** Use `enabled: !!params` — NOT `skipToken`. `skipToken` prevents `refetch()` from working in v5.

```typescript
// src/components/train-list.tsx
'use client'

import { useQuery } from '@tanstack/react-query'
import { Skeleton } from '@/components/ui/skeleton'
import { Button } from '@/components/ui/button'
import { TrainCard } from '@/components/train-card'
import { TrainTable } from '@/components/train-table'
import type { TdxEnrichedTrain } from '@/types/tdx'
import type { QueryParams } from '@/components/query-form'

interface TrainListProps {
  params: QueryParams | null
}

async function fetchTrains(params: QueryParams): Promise<TdxEnrichedTrain[]> {
  const url = `/api/tdx/trains?origin=${params.origin}&destination=${params.destination}&date=${params.date}`
  const res = await fetch(url)
  if (!res.ok) {
    const body = await res.json().catch(() => ({}))
    throw new Error(body.error ?? `查詢失敗（HTTP ${res.status}）`)
  }
  return res.json()
}

function TrainSkeletons() {
  // 5 skeleton cards — per user decision on skeleton count (Claude discretion: 5)
  return (
    <div className="space-y-3">
      {Array.from({ length: 5 }).map((_, i) => (
        <div key={i} className="rounded-lg border p-4 space-y-3">
          <div className="flex justify-between">
            <Skeleton className="h-5 w-16" />
            <Skeleton className="h-5 w-24" />
          </div>
          <div className="flex gap-2">
            <Skeleton className="h-4 w-12" />
            <Skeleton className="h-4 w-4" />
            <Skeleton className="h-4 w-12" />
          </div>
          <Skeleton className="h-8 w-full" />
        </div>
      ))}
    </div>
  )
}

export function TrainList({ params }: TrainListProps) {
  const { data, isLoading, isError, error, refetch } = useQuery({
    queryKey: ['trains', params],
    queryFn: () => {
      if (!params) throw new Error('No params')
      return fetchTrains(params)
    },
    enabled: !!params,           // Only fires when form has been submitted
    staleTime: 5 * 60 * 1000,   // 5 min client cache — TDX updates seat status every 10 min
    retry: 1,                    // One retry on failure before showing error state
  })

  // --- State: Idle (no query submitted yet) ---
  if (!params) {
    return (
      <p className="text-center text-muted-foreground py-12">
        選擇起訖站與日期，即可查詢時刻表
      </p>
    )
  }

  // --- State: Loading ---
  if (isLoading) {
    return <TrainSkeletons />
  }

  // --- State: Error ---
  if (isError) {
    return (
      <div className="text-center py-12 space-y-3">
        <p className="text-destructive text-sm">
          {error instanceof Error ? error.message : '查詢時發生錯誤，請稍後再試'}
        </p>
        <Button variant="outline" size="sm" onClick={() => refetch()}>
          重試
        </Button>
      </div>
    )
  }

  // --- State: Empty ---
  if (!data?.length) {
    return (
      <p className="text-center text-muted-foreground py-12">
        無符合的班次
      </p>
    )
  }

  // --- State: Results ---
  // Mobile: card list (hidden on md and above)
  // Desktop: table (hidden below md)
  return (
    <div>
      {/* Mobile cards */}
      <div className="md:hidden space-y-3">
        {data.map(train => (
          <TrainCard
            key={train.trainNo}
            train={train}
            origin={params.origin}
            destination={params.destination}
            date={params.date}
          />
        ))}
      </div>

      {/* Desktop table */}
      <div className="hidden md:block">
        <TrainTable
          trains={data}
          origin={params.origin}
          destination={params.destination}
          date={params.date}
        />
      </div>
    </div>
  )
}
```
  </action>
  <verify>
1. `npx tsc --noEmit` — 0 errors
2. `grep "enabled.*params" src/components/train-list.tsx` — enabled pattern found (NOT skipToken)
3. `grep "md:hidden" src/components/train-list.tsx` — mobile/desktop toggle present
4. `grep "refetch" src/components/train-list.tsx` — 重試 button calls refetch()
5. `grep "TrainCard\|TrainTable" src/components/train-list.tsx` — both imported and used
6. `npm run build` — 0 TypeScript errors (route warnings acceptable)
  </verify>
  <done>
    - `src/components/train-list.tsx` exports `TrainList` component
    - Renders idle/loading/error/empty/results states per user decisions
    - `enabled: !!params` pattern used (not skipToken)
    - Mobile: `md:hidden` card list; Desktop: `hidden md:block` table
    - Error state shows error message + 重試 button calling `refetch()`
    - Loading state shows 5 Skeleton cards
    - TypeScript 0 errors
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes with 0 errors
- `grep "enabled.*!!params" src/components/train-list.tsx` confirms correct React Query v5 pattern
- `grep "thsrc.com.tw" src/components/train-card.tsx src/components/train-table.tsx` — booking link found in both
- `grep "md:hidden" src/components/train-list.tsx` and `grep "hidden md:block" src/components/train-list.tsx` — responsive toggle present
- `npm run build` succeeds
</verification>

<success_criteria>
- `TrainCard`, `TrainTable`, `TrainList` all exported from their respective files
- All 4 display states implemented: idle hint / skeleton loading / error + retry / results
- Booking link is form POST to `https://www.thsrc.com.tw/TimeTable/Search` with pre-filled fields
- Mobile/desktop responsive toggle with `md:hidden` / `hidden md:block` pattern
- No TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-query/02-03-SUMMARY.md`
</output>
