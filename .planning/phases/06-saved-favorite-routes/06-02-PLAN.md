---
phase: 06-saved-favorite-routes
plan: 02
type: execute
wave: 2
depends_on: [06-01]
files_modified:
  - src/components/favorite-route-chips.tsx
  - src/components/query-form.tsx
autonomous: true
requirements: [PERS-01, PERS-03]

must_haves:
  truths:
    - "Save button appears in QueryForm only when origin and destination are selected and they differ"
    - "Save button is hidden (not disabled) when favorites are at capacity (isFull)"
    - "FavoriteRouteChips renders nothing when favorites array is empty"
    - "Clicking a chip calls onApply with the route — does not auto-submit the query"
    - "Clicking the X inside a chip deletes only that chip — does not trigger onApply"
    - "Chip labels show Chinese station names, not raw StationID strings"
  artifacts:
    - path: "src/components/favorite-route-chips.tsx"
      provides: "Chip list rendering saved routes with apply + delete actions"
      exports: ["FavoriteRouteChips"]
    - path: "src/components/query-form.tsx"
      provides: "QueryForm extended with onSave callback + isFavoriteFull prop"
      exports: ["QueryForm", "QueryParams"]
  key_links:
    - from: "src/components/favorite-route-chips.tsx"
      to: "src/types/favorites.ts"
      via: "FavoriteRoute type import"
      pattern: "import.*FavoriteRoute"
    - from: "src/components/favorite-route-chips.tsx"
      to: "src/types/tdx.ts"
      via: "TdxStation type for name resolution"
      pattern: "import.*TdxStation"
    - from: "src/components/query-form.tsx"
      to: "onSave callback prop"
      via: "Button onClick calling onSave(origin, destination)"
      pattern: "onSave.*origin.*destination"
---

<objective>
Build the two UI components that surface the favorites feature: FavoriteRouteChips (chip list with delete) and an extended QueryForm with a save button.

Purpose: These components are the visible user interface for PERS-01 (save routes) and PERS-03 (apply/delete routes). They are implemented as pure presentational components — all state and callbacks come from props, making them independently testable and easy to wire in page.tsx (Plan 03).
Output: Two component files; FavoriteRouteChips is new, QueryForm is extended with two optional props.
</objective>

<execution_context>
@/Users/diamond.hung/.claude/get-shit-done/workflows/execute-plan.md
@/Users/diamond.hung/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-saved-favorite-routes/06-RESEARCH.md
@src/components/query-form.tsx
@src/types/favorites.ts
@src/types/tdx.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create FavoriteRouteChips component</name>
  <files>src/components/favorite-route-chips.tsx</files>
  <action>
Create `src/components/favorite-route-chips.tsx` using the existing shadcn/ui Badge component as chips and lucide-react X icon for the delete button. Both are already installed in the project.

```typescript
// src/components/favorite-route-chips.tsx
'use client'

import { X } from 'lucide-react'
import { Badge } from '@/components/ui/badge'
import type { FavoriteRoute } from '@/types/favorites'
import type { TdxStation } from '@/types/tdx'

interface FavoriteRouteChipsProps {
  favorites: FavoriteRoute[]
  stations: TdxStation[]
  onApply: (route: FavoriteRoute) => void
  onRemove: (index: number) => void
}

export function FavoriteRouteChips({
  favorites,
  stations,
  onApply,
  onRemove,
}: FavoriteRouteChipsProps) {
  if (favorites.length === 0) return null

  function getStationName(id: string): string {
    return stations.find(s => s.StationID === id)?.StationName.Zh_tw ?? id
  }

  return (
    <div className="flex flex-wrap gap-2 mb-3">
      {favorites.map((route, index) => (
        <Badge
          key={`${route.origin}-${route.destination}-${index}`}
          variant="secondary"
          className="cursor-pointer hover:bg-secondary/80 pr-1 gap-1"
          onClick={() => onApply(route)}
        >
          <span>
            {getStationName(route.origin)} → {getStationName(route.destination)}
          </span>
          <button
            type="button"
            aria-label={`刪除 ${getStationName(route.origin)} 到 ${getStationName(route.destination)}`}
            className="ml-0.5 rounded-full hover:bg-destructive/20 p-0.5"
            onClick={(e) => {
              e.stopPropagation()  // prevent onApply from firing when deleting
              onRemove(index)
            }}
          >
            <X className="h-3 w-3" />
          </button>
        </Badge>
      ))}
    </div>
  )
}
```

Key points:
- `e.stopPropagation()` on the delete button is required — without it, clicking X also triggers the Badge's `onClick` (onApply), which would fill the form with a route the user just deleted
- `key` uses compound `${origin}-${destination}-${index}` — pure index-based keys break when items are removed from the middle of the array
- `getStationName` falls back to raw ID when stations are still loading — avoids undefined display during the ~200ms station fetch
- Returns `null` when favorites is empty — renders nothing, no empty space
  </action>
  <verify>`npx tsc --noEmit` passes. Confirm Badge is imported from '@/components/ui/badge' (not a different path). Confirm X is imported from 'lucide-react'.</verify>
  <done>File exists at src/components/favorite-route-chips.tsx, exports FavoriteRouteChips, renders null when favorites.length === 0, delete button stops propagation to prevent onApply firing.</done>
</task>

<task type="auto">
  <name>Task 2: Extend QueryForm with save button</name>
  <files>src/components/query-form.tsx</files>
  <action>
Extend the existing QueryForm component with two new optional props and a save button. Read the existing file first to understand the current structure, then make targeted additions.

**Props interface — add two optional props:**
```typescript
interface QueryFormProps {
  onSubmit: (params: QueryParams) => void
  initialOrigin?: string
  initialDestination?: string
  initialDate?: string
  onSave?: (origin: string, destination: string) => void  // NEW: called when user saves route
  isFavoriteFull?: boolean                                 // NEW: hide save button when at capacity
}
```

**Import — add Star icon from lucide-react:**
```typescript
import { ArrowLeftRight, CalendarIcon, Search, Star } from 'lucide-react'
```

**Save button — add after the submit button in the JSX, inside the `<form>` element:**
```typescript
{/* Save route button — hidden when at capacity or when no valid OD pair selected */}
{onSave && !isFavoriteFull && origin && destination && origin !== destination && (
  <Button
    type="button"
    variant="outline"
    size="sm"
    onClick={() => onSave(origin, destination)}
    className="w-full"
  >
    <Star className="mr-2 h-4 w-4" />
    儲存路線
  </Button>
)}
```

**Visibility rules (all must be true for button to show):**
1. `onSave` prop is provided (truthy) — button is opt-in; QueryForm works without favorites
2. `!isFavoriteFull` — hidden (not disabled) when the 10-route limit is reached per PERS-01 spec
3. `origin && destination` — both stations must be selected
4. `origin !== destination` — matches the existing `isValid` guard; same station is not a valid route

**Do not** add the save button inside the mobile StationLinePicker section or the desktop Select row — place it as a separate full-width row after the submit button so it renders identically on all screen sizes.
  </action>
  <verify>`npx tsc --noEmit` passes. Confirm QueryFormProps interface has `onSave?` and `isFavoriteFull?` fields. Confirm save button is conditionally rendered (not always visible).</verify>
  <done>src/components/query-form.tsx has onSave and isFavoriteFull in QueryFormProps, Star imported from lucide-react, save button renders as full-width outline button after the submit button with correct visibility conditions.</done>
</task>

</tasks>

<verification>
`npx tsc --noEmit` exits 0.
Inspect FavoriteRouteChips: `e.stopPropagation()` present on delete button click handler.
Inspect QueryForm: save button conditional includes `onSave && !isFavoriteFull && origin && destination && origin !== destination`.
</verification>

<success_criteria>
- src/components/favorite-route-chips.tsx: FavoriteRouteChips exported, returns null for empty favorites, chip delete stops propagation
- src/components/query-form.tsx: onSave + isFavoriteFull props added (both optional), Star icon imported, save button conditionally rendered after submit button
- Both files type-check cleanly with `npx tsc --noEmit`
- No new npm packages installed
</success_criteria>

<output>
After completion, create `.planning/phases/06-saved-favorite-routes/06-02-SUMMARY.md`
</output>
