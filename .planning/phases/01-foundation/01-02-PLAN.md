---
phase: 01-foundation
plan: "02"
type: execute
wave: 2
depends_on:
  - "01-01"
files_modified:
  - src/types/tdx.ts
  - src/fixtures/tdx-mock.ts
  - src/lib/tdx-token.ts
  - src/lib/tdx-api.ts
  - src/app/api/tdx/stations/route.ts
autonomous: true
requirements:
  - INTG-01
  - INTG-02
  - INTG-03

must_haves:
  truths:
    - "curl http://localhost:3000/api/tdx/stations returns a JSON array of 12 station objects"
    - "`npm run build` succeeds with no TDX credentials — mock data serves all 12 stations"
    - "Client bundle contains no TDX_CLIENT_ID or TDX_CLIENT_SECRET strings"
    - "Importing lib/tdx-token.ts in a 'use client' file causes a build error (server-only guard works)"
    - "Each station object has StationUID, StationID, StationName.Zh_tw, StationName.En, StationPosition"
  artifacts:
    - path: "src/types/tdx.ts"
      provides: "TdxStation TypeScript interface matching real TDX API response shape"
      exports: ["TdxStation"]
    - path: "src/fixtures/tdx-mock.ts"
      provides: "MOCK_STATIONS array with all 12 THSR stations in StationID order (1=南港 to 12=左營)"
      exports: ["MOCK_STATIONS"]
    - path: "src/lib/tdx-token.ts"
      provides: "getTdxToken() with module-level cache, server-only guard"
      exports: ["getTdxToken"]
    - path: "src/lib/tdx-api.ts"
      provides: "fetchStations() with isMockMode() auto-detect — real TDX or fixture fallback"
      exports: ["fetchStations", "isMockMode"]
    - path: "src/app/api/tdx/stations/route.ts"
      provides: "GET /api/tdx/stations — proxies fetchStations(), never exposes credentials"
      exports: ["GET"]
  key_links:
    - from: "src/lib/tdx-token.ts"
      to: "server-only"
      via: "import 'server-only' as first line"
      pattern: "import 'server-only'"
    - from: "src/lib/tdx-api.ts"
      to: "src/lib/tdx-token.ts"
      via: "getTdxToken() called only when isMockMode() is false"
      pattern: "getTdxToken"
    - from: "src/lib/tdx-api.ts"
      to: "src/fixtures/tdx-mock.ts"
      via: "MOCK_STATIONS returned when isMockMode() is true"
      pattern: "MOCK_STATIONS"
    - from: "src/app/api/tdx/stations/route.ts"
      to: "src/lib/tdx-api.ts"
      via: "fetchStations() import — Route Handler never imports tdx-token.ts directly"
      pattern: "fetchStations"
---

<objective>
Implement the TDX credential security layer: TypeScript types, fixture mock data, OAuth2 token manager with server-only guard, API helper with mock/real auto-detect, and the `/api/tdx/stations` Route Handler proxy.

Purpose: This is the core security requirement. TDX credentials must never reach the browser. The `server-only` package enforces this at build time. The mock/real auto-detect means development works without TDX credentials.

Output: Five files implementing the complete credential boundary. `/api/tdx/stations` returns 12 THSR stations — from mock fixture if no credentials, from real TDX API if credentials are set.
</objective>

<execution_context>
@/Users/diamond.hung/.claude/get-shit-done/workflows/execute-plan.md
@/Users/diamond.hung/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation/01-RESEARCH.md
@.planning/phases/01-foundation/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TDX types, fixture mock data, and server-only token manager</name>
  <files>
    src/types/tdx.ts
    src/fixtures/tdx-mock.ts
    src/lib/tdx-token.ts
  </files>
  <action>
    Create `src/types/tdx.ts` — TypeScript interface derived from TDX v2 API response shape. This MUST be created first so mock data and the token manager both implement the same types:

    ```typescript
    // src/types/tdx.ts
    // TDX API v2 response shapes for THSR endpoints
    // Source: TDX official SampleCode + existing Vue 2 field usage in _archive/src/

    export interface TdxStationName {
      Zh_tw: string  // Chinese name, e.g. "南港"
      En: string     // English name, e.g. "Nangang"
    }

    export interface TdxStationPosition {
      PositionLat: number
      PositionLon: number
    }

    export interface TdxStation {
      StationUID: string          // e.g. "THSR-1"
      StationID: string           // e.g. "1" (string, not number)
      StationName: TdxStationName
      StationPosition: TdxStationPosition
      StationAddress: string
      BikeAllowOnHoliday: boolean
      SrcUpdateTime: string       // ISO 8601 with TZ offset
      UpdateTime: string          // ISO 8601 with TZ offset
      VersionID: number
    }
    ```

    Create `src/fixtures/tdx-mock.ts` — all 12 THSR stations in StationID order (1=南港 to 12=左營). These coordinates and addresses are real THSR station data:

    ```typescript
    // src/fixtures/tdx-mock.ts
    // Mock data matching real TDX API response format for /Station endpoint
    // Used when TDX_CLIENT_ID / TDX_CLIENT_SECRET env vars are not set
    import type { TdxStation } from '@/types/tdx'

    export const MOCK_STATIONS: TdxStation[] = [
      {
        StationUID: 'THSR-1',
        StationID: '1',
        StationName: { Zh_tw: '南港', En: 'Nangang' },
        StationPosition: { PositionLat: 25.0531, PositionLon: 121.6076 },
        StationAddress: '台北市南港區忠孝東路七段338號',
        BikeAllowOnHoliday: true,
        SrcUpdateTime: '2024-01-01T00:00:00+08:00',
        UpdateTime: '2024-01-01T00:00:00+08:00',
        VersionID: 1,
      },
      {
        StationUID: 'THSR-2',
        StationID: '2',
        StationName: { Zh_tw: '台北', En: 'Taipei' },
        StationPosition: { PositionLat: 25.0150, PositionLon: 121.5172 },
        StationAddress: '台北市中正區北平西路3號',
        BikeAllowOnHoliday: true,
        SrcUpdateTime: '2024-01-01T00:00:00+08:00',
        UpdateTime: '2024-01-01T00:00:00+08:00',
        VersionID: 1,
      },
      {
        StationUID: 'THSR-3',
        StationID: '3',
        StationName: { Zh_tw: '板橋', En: 'Banqiao' },
        StationPosition: { PositionLat: 24.9991, PositionLon: 121.4594 },
        StationAddress: '新北市板橋區縣民大道二段7號',
        BikeAllowOnHoliday: true,
        SrcUpdateTime: '2024-01-01T00:00:00+08:00',
        UpdateTime: '2024-01-01T00:00:00+08:00',
        VersionID: 1,
      },
      {
        StationUID: 'THSR-4',
        StationID: '4',
        StationName: { Zh_tw: '桃園', En: 'Taoyuan' },
        StationPosition: { PositionLat: 24.9706, PositionLon: 121.2271 },
        StationAddress: '桃園市中壢區高鐵北路一段6號',
        BikeAllowOnHoliday: true,
        SrcUpdateTime: '2024-01-01T00:00:00+08:00',
        UpdateTime: '2024-01-01T00:00:00+08:00',
        VersionID: 1,
      },
      {
        StationUID: 'THSR-5',
        StationID: '5',
        StationName: { Zh_tw: '新竹', En: 'Hsinchu' },
        StationPosition: { PositionLat: 24.8060, PositionLon: 120.9769 },
        StationAddress: '新竹縣竹北市高鐵七路一段8號',
        BikeAllowOnHoliday: true,
        SrcUpdateTime: '2024-01-01T00:00:00+08:00',
        UpdateTime: '2024-01-01T00:00:00+08:00',
        VersionID: 1,
      },
      {
        StationUID: 'THSR-6',
        StationID: '6',
        StationName: { Zh_tw: '苗栗', En: 'Miaoli' },
        StationPosition: { PositionLat: 24.5673, PositionLon: 120.8230 },
        StationAddress: '苗栗縣後龍鎮高鐵路6號',
        BikeAllowOnHoliday: true,
        SrcUpdateTime: '2024-01-01T00:00:00+08:00',
        UpdateTime: '2024-01-01T00:00:00+08:00',
        VersionID: 1,
      },
      {
        StationUID: 'THSR-7',
        StationID: '7',
        StationName: { Zh_tw: '台中', En: 'Taichung' },
        StationPosition: { PositionLat: 24.2677, PositionLon: 120.6936 },
        StationAddress: '台中市烏日區站區一路99號',
        BikeAllowOnHoliday: true,
        SrcUpdateTime: '2024-01-01T00:00:00+08:00',
        UpdateTime: '2024-01-01T00:00:00+08:00',
        VersionID: 1,
      },
      {
        StationUID: 'THSR-8',
        StationID: '8',
        StationName: { Zh_tw: '彰化', En: 'Changhua' },
        StationPosition: { PositionLat: 23.9979, PositionLon: 120.5956 },
        StationAddress: '彰化縣田中鎮中南路一段188號',
        BikeAllowOnHoliday: true,
        SrcUpdateTime: '2024-01-01T00:00:00+08:00',
        UpdateTime: '2024-01-01T00:00:00+08:00',
        VersionID: 1,
      },
      {
        StationUID: 'THSR-9',
        StationID: '9',
        StationName: { Zh_tw: '雲林', En: 'Yunlin' },
        StationPosition: { PositionLat: 23.7130, PositionLon: 120.4438 },
        StationAddress: '雲林縣虎尾鎮高鐵站前路8號',
        BikeAllowOnHoliday: true,
        SrcUpdateTime: '2024-01-01T00:00:00+08:00',
        UpdateTime: '2024-01-01T00:00:00+08:00',
        VersionID: 1,
      },
      {
        StationUID: 'THSR-10',
        StationID: '10',
        StationName: { Zh_tw: '嘉義', En: 'Chiayi' },
        StationPosition: { PositionLat: 23.4960, PositionLon: 120.2987 },
        StationAddress: '嘉義縣太保市高鐵一路東段5號',
        BikeAllowOnHoliday: true,
        SrcUpdateTime: '2024-01-01T00:00:00+08:00',
        UpdateTime: '2024-01-01T00:00:00+08:00',
        VersionID: 1,
      },
      {
        StationUID: 'THSR-11',
        StationID: '11',
        StationName: { Zh_tw: '台南', En: 'Tainan' },
        StationPosition: { PositionLat: 22.9989, PositionLon: 120.2319 },
        StationAddress: '台南市歸仁區高鐵路一段5號',
        BikeAllowOnHoliday: true,
        SrcUpdateTime: '2024-01-01T00:00:00+08:00',
        UpdateTime: '2024-01-01T00:00:00+08:00',
        VersionID: 1,
      },
      {
        StationUID: 'THSR-12',
        StationID: '12',
        StationName: { Zh_tw: '左營', En: 'Zuoying' },
        StationPosition: { PositionLat: 22.6978, PositionLon: 120.2931 },
        StationAddress: '高雄市左營區高鐵路9號',
        BikeAllowOnHoliday: true,
        SrcUpdateTime: '2024-01-01T00:00:00+08:00',
        UpdateTime: '2024-01-01T00:00:00+08:00',
        VersionID: 1,
      },
    ]
    ```

    Create `src/lib/tdx-token.ts` — OAuth2 token manager with module-level cache. `import 'server-only'` MUST be the first import:

    ```typescript
    // src/lib/tdx-token.ts
    import 'server-only'  // Build error if imported in any 'use client' file

    const TDX_AUTH_URL =
      'https://tdx.transportdata.tw/auth/realms/TDXConnect/protocol/openid-connect/token'

    interface CachedToken {
      value: string
      expiresAt: number  // Date.now() in milliseconds
    }

    // Module-level cache — persists across requests within the same Vercel function instance
    // On cold start: null (fetches fresh). On warm requests: returns cached token.
    let cachedToken: CachedToken | null = null

    export async function getTdxToken(): Promise<string> {
      const now = Date.now()
      // Return cached token if still valid with 5-minute safety buffer
      if (cachedToken && cachedToken.expiresAt > now + 5 * 60 * 1000) {
        return cachedToken.value
      }

      const params = new URLSearchParams({
        grant_type: 'client_credentials',
        client_id: process.env.TDX_CLIENT_ID!,
        client_secret: process.env.TDX_CLIENT_SECRET!,
      })

      const res = await fetch(TDX_AUTH_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: params.toString(),
        cache: 'no-store',  // Never cache the auth request itself
      })

      if (!res.ok) {
        throw new Error(`TDX auth failed: ${res.status} ${res.statusText}`)
      }

      const data = await res.json()
      // TDX token TTL: 86400s (24h), verified via official TDX SampleCode repo
      cachedToken = {
        value: data.access_token,
        expiresAt: now + data.expires_in * 1000,
      }

      return cachedToken.value
    }
    ```
  </action>
  <verify>
    Run: `npm run build`
    Expected: TypeScript compiles without errors. No type mismatches between `TdxStation` and `MOCK_STATIONS`.

    Run: `cat src/lib/tdx-token.ts | head -2`
    Expected: First line is `import 'server-only'`.

    Run: `cat src/fixtures/tdx-mock.ts | grep StationUID | wc -l`
    Expected: 12 (one per station).
  </verify>
  <done>
    `src/types/tdx.ts` exports `TdxStation` interface. `src/fixtures/tdx-mock.ts` exports `MOCK_STATIONS` array with exactly 12 stations typed as `TdxStation[]`. `src/lib/tdx-token.ts` first line is `import 'server-only'`, implements module-level token cache with 5-minute buffer. TypeScript build succeeds.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement TDX API helper and stations Route Handler proxy</name>
  <files>
    src/lib/tdx-api.ts
    src/app/api/tdx/stations/route.ts
  </files>
  <action>
    Create `src/lib/tdx-api.ts` — server-only API helper with mock/real auto-detect. `import 'server-only'` MUST be first:

    ```typescript
    // src/lib/tdx-api.ts
    import 'server-only'  // Build error if imported in any 'use client' file

    import { getTdxToken } from './tdx-token'
    import { MOCK_STATIONS } from '@/fixtures/tdx-mock'
    import type { TdxStation } from '@/types/tdx'

    const TDX_BASE = 'https://tdx.transportdata.tw/api/basic/v2/Rail/THSR'

    /**
     * Returns true if TDX credentials are not set — use mock data.
     * Returns false if credentials exist — call real TDX API.
     * Per user decision: no USE_MOCK_TDX flag; env var presence determines behavior.
     */
    export function isMockMode(): boolean {
      return !process.env.TDX_CLIENT_ID || !process.env.TDX_CLIENT_SECRET
    }

    /**
     * Fetch all THSR stations.
     * Mock mode: returns MOCK_STATIONS fixture data (12 stations).
     * Real mode: calls TDX API GET /Station with Bearer token.
     */
    export async function fetchStations(): Promise<TdxStation[]> {
      if (isMockMode()) {
        return MOCK_STATIONS
      }

      const token = await getTdxToken()
      const res = await fetch(`${TDX_BASE}/Station`, {
        headers: { Authorization: `Bearer ${token}` },
        next: { revalidate: 86400 },  // Cache station list for 24h (stations rarely change)
      })

      if (!res.ok) {
        throw new Error(`TDX /Station failed: ${res.status} ${res.statusText}`)
      }

      const data = await res.json()
      // Handle both bare array and wrapped { Stations: [...] } response shapes
      // Verify actual shape when TDX credentials are obtained
      return Array.isArray(data) ? data : (data.Stations ?? data)
    }
    ```

    Create `src/app/api/tdx/stations/route.ts` — the Route Handler that proxies station data to the client. This file MUST NOT import `tdx-token.ts` directly — only via `tdx-api.ts`:

    ```typescript
    // src/app/api/tdx/stations/route.ts
    import { fetchStations } from '@/lib/tdx-api'
    import { NextResponse } from 'next/server'

    // Station list is static — revalidate every 24h or on-demand
    export const revalidate = 86400

    export async function GET() {
      try {
        const stations = await fetchStations()
        return NextResponse.json(stations)
      } catch (error) {
        console.error('[/api/tdx/stations] Error:', error)
        return NextResponse.json(
          { error: 'Failed to fetch station data' },
          { status: 502 }
        )
      }
    }
    ```

    After writing these files, verify the security boundary by attempting to import `tdx-token.ts` in a test client component, then removing it:
    1. Temporarily create `src/app/test-client.tsx` with `'use client'` + `import { getTdxToken } from '@/lib/tdx-token'`
    2. Run `npm run build` — it MUST fail with "server-only" boundary error
    3. Delete `src/app/test-client.tsx`
    4. Run `npm run build` again — must succeed

    This confirms the `server-only` guard works correctly.
  </action>
  <verify>
    Run: `npm run dev` (start dev server)

    In a separate terminal: `curl http://localhost:3000/api/tdx/stations`
    Expected: JSON array starting with `[{"StationUID":"THSR-1","StationID":"1","StationName":{"Zh_tw":"南港"...`

    Count stations: `curl -s http://localhost:3000/api/tdx/stations | node -e "const d=require('fs').readFileSync('/dev/stdin','utf8'); console.log(JSON.parse(d).length)"`
    Expected: 12

    Run: `npm run build`
    Expected: Build succeeds. In build output, `/api/tdx/stations` appears as a static route.

    Run: `grep -r "TDX_CLIENT" .next/ 2>/dev/null | grep -v "Binary" | head -5`
    Expected: No output (credentials do not appear in client bundle).
  </verify>
  <done>
    `GET /api/tdx/stations` returns a JSON array of exactly 12 stations with correct `TdxStation` shape. Build succeeds without TDX credentials. `grep` of `.next/` directory finds no TDX credential strings. The `server-only` boundary violation test caused a build error confirming the guard works.
  </done>
</task>

</tasks>

<verification>
Overall Plan 02 security checks:

1. `curl http://localhost:3000/api/tdx/stations | node -e "process.stdin.resume();let d='';process.stdin.on('data',c=>d+=c);process.stdin.on('end',()=>console.log(JSON.parse(d).length))"` → 12
2. `cat src/lib/tdx-token.ts | head -1` → `import 'server-only'`
3. `cat src/lib/tdx-api.ts | head -1` → `import 'server-only'`
4. `npm run build` with empty `.env.local` → succeeds
5. `grep -r "client_credentials\|TDX_CLIENT" .next/static/ 2>/dev/null` → no results (credential strings not in client bundle)
6. `cat src/app/api/tdx/stations/route.ts | grep tdx-token` → no direct import (only imports from tdx-api)
</verification>

<success_criteria>
- `curl http://localhost:3000/api/tdx/stations` returns array of 12 stations
- Each station has StationUID, StationID, StationName.Zh_tw, StationName.En, StationPosition
- `npm run build` succeeds with no TDX credentials in environment
- First line of `src/lib/tdx-token.ts` is `import 'server-only'`
- First line of `src/lib/tdx-api.ts` is `import 'server-only'`
- `src/app/api/tdx/stations/route.ts` does NOT import from `tdx-token.ts` directly
- Client bundle (`.next/static/`) contains no TDX credential strings
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-02-SUMMARY.md` using the summary template.
</output>
