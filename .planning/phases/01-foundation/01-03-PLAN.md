---
phase: 01-foundation
plan: "03"
type: execute
wave: 3
depends_on:
  - "01-01"
  - "01-02"
files_modified:
  - .env.local
autonomous: false
requirements:
  - INFR-02
  - INTG-03

user_setup:
  - service: vercel
    why: "Deployment target for the Next.js app"
    env_vars:
      - name: TDX_CLIENT_ID
        source: "TDX portal (https://tdx.transportdata.tw) — Project Settings → App Info"
      - name: TDX_CLIENT_SECRET
        source: "TDX portal (https://tdx.transportdata.tw) — Project Settings → App Info"
    dashboard_config:
      - task: "Add TDX_CLIENT_ID and TDX_CLIENT_SECRET as environment variables"
        location: "Vercel Dashboard → Project → Settings → Environment Variables"
        note: "Set for Production and Preview environments. Leave Development blank (local .env.local handles dev)."

must_haves:
  truths:
    - "Vercel CLI deploys the project successfully with `vercel --yes`"
    - "The deployed Vercel URL returns 200 for the home page"
    - "The deployed `/api/tdx/stations` returns 12 stations (mock mode if no TDX credentials on Vercel)"
    - "TDX_CLIENT_ID and TDX_CLIENT_SECRET are noted for Vercel dashboard setup (even if user hasn't obtained them yet)"
  artifacts:
    - path: ".env.local"
      provides: "Local TDX credential placeholder file (not committed to git)"
      contains: "TDX_CLIENT_ID= and TDX_CLIENT_SECRET= lines"
  key_links:
    - from: "Vercel project"
      to: "GitHub repo"
      via: "vercel --yes CLI deployment linking repo to Vercel project"
      pattern: "vercel"
---

<objective>
Deploy the working Next.js 16 app to Vercel and verify the deployment serves the stations endpoint. Document the TDX credential setup instructions for when the user obtains TDX API access.

Purpose: Vercel deployment validates the full stack works in a production environment, not just locally. The `autonomous: false` flag reflects the human checkpoint needed to confirm the deployed URL works.

Note: Per user decision, successful Vercel deployment is part of Phase 1 but NOT a prerequisite for Phase 2. If deployment encounters issues (Vercel auth, DNS, etc.), document the blocker and proceed to Phase 2.

Output: A live Vercel deployment URL, and clear instructions for adding TDX credentials to Vercel dashboard when the user obtains them.
</objective>

<execution_context>
@/Users/diamond.hung/.claude/get-shit-done/workflows/execute-plan.md
@/Users/diamond.hung/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation/01-RESEARCH.md
@.planning/phases/01-foundation/01-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Deploy to Vercel via CLI and document credential setup</name>
  <files>
    .env.local
  </files>
  <action>
    Step 1 — Verify Vercel CLI is available:
    ```
    npx vercel --version
    ```
    If not installed: `npm install -g vercel`

    Step 2 — Run production deployment from the project root. Vercel auto-detects Next.js framework:
    ```
    npx vercel --yes
    ```
    This links the repo to a Vercel project and deploys. If not logged in, `vercel` will prompt for authentication — complete the login flow in the browser.

    When prompted during first-time setup, accept the defaults:
    - Set up and deploy: Yes
    - Which scope: (select the user's personal account)
    - Link to existing project: No (create new)
    - What's your project's name: `thsr-query` (or accept default)
    - In which directory is your code located: `.` (current directory)

    Step 3 — Note the deployment URL from CLI output (format: `https://thsr-query-xxxx.vercel.app`).

    Step 4 — Verify the deployment:
    ```
    curl https://<deployment-url>/api/tdx/stations
    ```
    Expected: JSON array of 12 stations (mock mode — no credentials on Vercel yet).

    Step 5 — Update `.env.local` to document what needs to go into Vercel dashboard:
    Ensure `.env.local` has this format:
    ```
    # TDX API credentials — obtain from https://tdx.transportdata.tw
    # Development: set values here for local development with real API
    # Production: set these in Vercel Dashboard → Settings → Environment Variables
    TDX_CLIENT_ID=
    TDX_CLIENT_SECRET=
    ```

    Step 6 — Print Vercel dashboard environment variable instructions to terminal output so they appear in the SUMMARY:
    ```
    echo "=== VERCEL ENV VAR SETUP ==="
    echo "Go to: https://vercel.com/dashboard → thsr-query → Settings → Environment Variables"
    echo "Add: TDX_CLIENT_ID (value from TDX portal)"
    echo "Add: TDX_CLIENT_SECRET (value from TDX portal)"
    echo "Set for: Production + Preview environments"
    echo "After adding, redeploy: npx vercel --prod"
    ```

    If `vercel --yes` fails due to authentication, run `npx vercel login` first, then retry. If deployment fails for any other reason, document the error in the SUMMARY and note this as a non-blocking issue for Phase 2.
  </action>
  <verify>
    Run: `curl https://<deployment-url>`
    Expected: HTTP 200, HTML response with "高鐵查詢" in content.

    Run: `curl https://<deployment-url>/api/tdx/stations`
    Expected: JSON array with 12 station objects.

    Run: `curl -s https://<deployment-url>/api/tdx/stations | node -e "const d=require('fs').readFileSync('/dev/stdin','utf8'); console.log(JSON.parse(d).length)"`
    Expected: 12
  </verify>
  <done>
    Vercel deployment URL is known. Home page returns 200. `/api/tdx/stations` returns 12 stations. Vercel dashboard env var instructions are documented in SUMMARY.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Checkpoint: Verify Phase 1 foundation end-to-end</name>
  <action>
    Human verification of the complete Phase 1 foundation. Run each check in order:

    1. Local dev server — `npm run dev`, visit http://localhost:3000
    2. Local API — `curl http://localhost:3000/api/tdx/stations` (expect 12 stations)
    3. Vercel home page — visit the deployment URL from Task 1
    4. Vercel API — `curl https://<vercel-url>/api/tdx/stations` (expect 12 stations)
    5. Browser DevTools Network tab — confirm no requests to `tdx.transportdata.tw` from browser
    6. (Optional with TDX credentials) Set TDX_CLIENT_ID + TDX_CLIENT_SECRET in `.env.local`, restart dev, re-run curl
  </action>
  <verify>
    All 5 required checks pass (step 6 optional).
    Human types "approved" or describes issues.
  </verify>
  <done>
    Human confirms: local dev works, local API returns 12 stations, Vercel deployment accessible, Vercel API returns 12 stations, no browser-side TDX requests visible in DevTools.
  </done>
</task>

</tasks>

<verification>
Phase 1 complete criteria:

1. `npm run build` succeeds with empty TDX env vars — mock data path works at build time
2. `curl http://localhost:3000/api/tdx/stations` — 12 stations in JSON
3. Vercel deployment URL accessible — home page 200, `/api/tdx/stations` 12 stations
4. `.env.local` not committed: `git status` shows `.env.local` as untracked or in `.gitignore`
5. Security: no TDX credentials in client bundle (`grep -r "TDX_CLIENT" .next/static/` returns nothing)
6. All 5 requirement IDs covered:
   - INFR-01: Next.js 16 App Router + TypeScript (Plan 01-01)
   - INFR-02: Vercel deployment + env var docs (Plan 01-03)
   - INTG-01: Route Handler proxy pattern (Plan 01-02)
   - INTG-02: Module-level token cache (Plan 01-02)
   - INTG-03: Env var management + .env.local (Plan 01-03)
</verification>

<success_criteria>
- Vercel deployment URL exists and returns 200 for home page
- `/api/tdx/stations` on Vercel returns JSON array of 12 stations (mock mode)
- `.env.local` is gitignored and not committed
- Vercel dashboard env var setup instructions are documented in SUMMARY
- Human verifier has confirmed all 6 verification steps above
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-03-SUMMARY.md` using the summary template.
Include the Vercel deployment URL in the SUMMARY's key artifacts section.
</output>
